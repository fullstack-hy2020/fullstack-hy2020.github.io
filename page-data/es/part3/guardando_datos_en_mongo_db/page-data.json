{"componentChunkName":"component---src-templates-content-template-js","path":"/es/part3/guardando_datos_en_mongo_db","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Antes de pasar al tema principal de persistir datos en una base de datos, veremos algunas formas diferentes de depurar aplicaciones de Node.</p>\n<h3>Depuración en aplicaciones de Node</h3>\n<p>Depurar (debugging) aplicaciones de Node es un poco más difícil que depurar JavaScript que se ejecuta en el navegador. Imprimir en la consola es un método probado y confiable, siempre vale la pena hacerlo. Hay personas que piensan que se deberían utilizar métodos más sofisticados en su lugar, pero no estoy de acuerdo. Incluso los desarrolladores de código abierto de élite del mundo <a href=\"https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html\">utilizan</a> este <a href=\"https://swizec.com/blog/javascript-debugging-slightly-beyond-consolelog/\">método</a>.</p>\n<h4>Visual Studio Code</h4>\n<p>El depurador de Visual Studio Code puede ser útil en algunas situaciones. Puedes iniciar la aplicación en modo de depuración de la siguiente manera (en esta y en las próximas imágenes, las notas tienen un campo <em>date</em> que se ha eliminado de la versión actual de la aplicación):</p>\n<picture><img src=\"/static/b97b10a73a2a6404f05e73cc9eaff622/5a190/35x.png\" alt=\"captura de pantalla mostrando como ejecutar el depurador de vscode\" srcset=\"/static/b97b10a73a2a6404f05e73cc9eaff622/772e8/35x.png 200w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/e17e5/35x.png 400w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/5a190/35x.png 800w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/c1b63/35x.png 1200w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/29007/35x.png 1600w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/c658e/35x.png 2202w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Ten en cuenta que la aplicación no debería ejecutarse en otra consola, de lo contrario, el puerto ya estará en uso.</p>\n<p><strong>NB</strong> Una versión más reciente de Visual Studio Code puede tener <em>Run</em> en lugar de <em>Debug</em>. Además, es posible que debas configurar tu archivo <em>launch.json</em> para comenzar a depurar. Esto se puede hacer eligiendo <em>Add Configuration...</em> en el menú desplegable, que se encuentra junto al botón de reproducción verde y arriba del menú <em>VARIABLES</em>, y seleccionando <em>Run \"npm start\" in a debug terminal</em>. Para obtener instrucciones de configuración más detalladas, visita la <a href=\"https://code.visualstudio.com/docs/editor/debugging\">documentación de depuración</a> de Visual Studio Code.</p>\n<p>A continuación, puedes ver una captura de pantalla donde la ejecución del código se ha detenido a medio camino de guardar una nueva nota:</p>\n<picture><img src=\"/static/feed4fe57ce10ff79881a5cbd155026b/5a190/36x.png\" alt=\"captura de pantalla de la ejecución de un breakpoint en vscode\" srcset=\"/static/feed4fe57ce10ff79881a5cbd155026b/772e8/36x.png 200w,\n/static/feed4fe57ce10ff79881a5cbd155026b/e17e5/36x.png 400w,\n/static/feed4fe57ce10ff79881a5cbd155026b/5a190/36x.png 800w,\n/static/feed4fe57ce10ff79881a5cbd155026b/c1b63/36x.png 1200w,\n/static/feed4fe57ce10ff79881a5cbd155026b/29007/36x.png 1600w,\n/static/feed4fe57ce10ff79881a5cbd155026b/7e9b1/36x.png 2252w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>La ejecución se ha detenido en el <i>breakpoint</i> (punto de interrupción) de la línea 69. En la consola puedes ver el valor de la variable de <i>note</i>. En la ventana superior izquierda puede ver otras cosas relacionadas con el estado de la aplicación.</p>\n<p>Las flechas en la parte superior se pueden utilizar para controlar el flujo del depurador.</p>\n<p>Por alguna razón, no uso mucho el debugger de Visual Studio Code.</p>\n<h4>Chrome dev tools</h4>\n<p>La depuración también es posible con la consola de desarrollo de Chrome iniciando su aplicación con el comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> <span class=\"token parameter variable\">--inspect</span> index.js</code></pre></div>\n<p>También puedes pasar la bandera <code class=\"language-text\">--inspect</code> a <code class=\"language-text\">nodemon</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">nodemon <span class=\"token parameter variable\">--inspect</span> index.js</code></pre></div>\n<p>Puedes acceder al depurador haciendo clic en el icono verde - el logotipo de node - que aparece en la consola de desarrollo de Chrome:</p>\n<picture><img src=\"/static/98eea9ee4f184a484417314745f7422a/5a190/37.png\" alt=\"herramientas de desarrolladores con logotipo verde de node\" srcset=\"/static/98eea9ee4f184a484417314745f7422a/772e8/37.png 200w,\n/static/98eea9ee4f184a484417314745f7422a/e17e5/37.png 400w,\n/static/98eea9ee4f184a484417314745f7422a/5a190/37.png 800w,\n/static/98eea9ee4f184a484417314745f7422a/c1b63/37.png 1200w,\n/static/98eea9ee4f184a484417314745f7422a/29007/37.png 1600w,\n/static/98eea9ee4f184a484417314745f7422a/bf286/37.png 1688w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>La vista de depuración funciona de la misma manera que con las aplicaciones React. La pestaña <i>Sources</i> se puede usar para establecer breakpoints donde se pausará la ejecución del código.</p>\n<picture><img src=\"/static/55e5f6c8afb83433a723a0da5c575a32/5a190/38eb.png\" alt=\"pestaña &#x22;Sources&#x22; de las herramientas de desarrollo con breakpoint y variables de observación\" srcset=\"/static/55e5f6c8afb83433a723a0da5c575a32/772e8/38eb.png 200w,\n/static/55e5f6c8afb83433a723a0da5c575a32/e17e5/38eb.png 400w,\n/static/55e5f6c8afb83433a723a0da5c575a32/5a190/38eb.png 800w,\n/static/55e5f6c8afb83433a723a0da5c575a32/c1b63/38eb.png 1200w,\n/static/55e5f6c8afb83433a723a0da5c575a32/29007/38eb.png 1600w,\n/static/55e5f6c8afb83433a723a0da5c575a32/828bd/38eb.png 2310w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Todos los mensajes <i>console.log</i> de la aplicación aparecerán en la pestaña <i>Console</i> del depurador. También puedes inspeccionar valores de variables y ejecutar tu propio código JavaScript.</p>\n<picture><img src=\"/static/f4ab60bfb4c362e50561a48eb231a212/5a190/39ea.png\" alt=\"pestaña &#x22;Consola&#x22; de las herramientas de desarrollo mostrando el objeto de nota escrito\" srcset=\"/static/f4ab60bfb4c362e50561a48eb231a212/772e8/39ea.png 200w,\n/static/f4ab60bfb4c362e50561a48eb231a212/e17e5/39ea.png 400w,\n/static/f4ab60bfb4c362e50561a48eb231a212/5a190/39ea.png 800w,\n/static/f4ab60bfb4c362e50561a48eb231a212/c1b63/39ea.png 1200w,\n/static/f4ab60bfb4c362e50561a48eb231a212/29007/39ea.png 1600w,\n/static/f4ab60bfb4c362e50561a48eb231a212/baa75/39ea.png 1746w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>Cuestionar todo</h4>\n<p>Depurar aplicaciones Full Stack puede parecer complicado al principio. Pronto nuestra aplicación también tendrá una base de datos además del frontend y el backend, y habrá muchas áreas con potenciales errores en la aplicación.</p>\n<p>Cuando la aplicación \"no funciona\", primero tenemos que averiguar dónde ocurre realmente el problema. Es muy común que el problema exista en un lugar donde no lo esperabas, y pueden pasar minutos, horas o incluso días antes de que encuentres la fuente del problema.</p>\n<p>La clave es ser sistemático. Dado que el problema puede estar en cualquier lugar, <i>debes cuestionarlo todo</i> y eliminar todas las posibilidades una por una. El registro en la consola, Postman, los depuradores y la experiencia te ayudarán.</p>\n<p>Cuando ocurren errores, <i>la peor de todas las estrategias posibles</i> es continuar escribiendo código. Garantizará que tu código pronto tendrá aún más errores, y depurarlos será aún más difícil. El principio <a href=\"https://blog.toyota-forklifts.es/jidoka-que-es\">Jidoka</a> (detenerse y reparar) de Toyota Production Systems también es muy eficaz en esta situación.</p>\n<h3>MongoDB</h3>\n<p>Para almacenar nuestras notas guardadas indefinidamente, necesitamos una base de datos. La mayoría de los cursos que se imparten en la Universidad de Helsinki utilizan bases de datos relacionales. En este curso usaremos <a href=\"https://www.mongodb.com/\">MongoDB</a>, que es una <a href=\"https://es.wikipedia.org/wiki/Base_de_datos_documental\">base de datos de documentos</a>.</p>\n<p>La razón para usar Mongo como la base de datos es su menor complejidad en comparación con una base de datos relacional. <a href=\"/es/part13\">La parte 13</a> del curso muestra cómo construir backends de Node.js que utilizan una base de datos relacional.</p>\n<p>Las bases de datos de documentos difieren de las bases de datos relacionales en cómo organizan los datos, así como en los lenguajes de consulta que admiten. Las bases de datos de documentos generalmente se clasifican bajo el término general <a href=\"https://es.wikipedia.org/wiki/NoSQL\">NoSQL</a>.</p>\n<p>Puedes leer más sobre bases de datos de documentos y NoSQL en el material del curso de la <a href=\"https://tikape-s18.mooc.fi/part7/\">semana 7</a> del curso Introducción a las bases de datos. Lamentablemente, el material actualmente solo está disponible en finlandés.</p>\n<p>Lee ahora los capítulos sobre <a href=\"https://docs.mongodb.com/manual/core/databases-and-collections/\">colecciones</a> y <a href=\"https://docs.mongodb.com/manual/core/document/\">documentos</a> del manual de MongoDB para tener una idea básica de cómo una base de datos de documentos almacena datos.</p>\n<p>Naturalmente, puedes instalar y ejecutar MongoDB en tu propia computadora. Sin embargo, Internet también está lleno de servicios de base de datos de Mongo que puedes utilizar. Nuestro proveedor preferido de MongoDB en este curso será <a href=\"https://www.mongodb.com/cloud/atlas\">MongoDB Atlas</a>.</p>\n<p>Una vez que hayas creado y accedido a tu cuenta, comencemos seleccionando la opción gratuita:</p>\n<picture><img src=\"/static/51357385d765c59103d23a83d7faa2ab/5a190/mongo1.png\" alt=\"mongodb deploy a cloud database free shared\" srcset=\"/static/51357385d765c59103d23a83d7faa2ab/772e8/mongo1.png 200w,\n/static/51357385d765c59103d23a83d7faa2ab/e17e5/mongo1.png 400w,\n/static/51357385d765c59103d23a83d7faa2ab/5a190/mongo1.png 800w,\n/static/51357385d765c59103d23a83d7faa2ab/c1b63/mongo1.png 1200w,\n/static/51357385d765c59103d23a83d7faa2ab/29007/mongo1.png 1600w,\n/static/51357385d765c59103d23a83d7faa2ab/c9d77/mongo1.png 1964w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Elige el proveedor de la nube y la ubicación, y crea el clúster:</p>\n<picture><img src=\"/static/ce9c4c24088c7122099309a59a450d08/5a190/mongo2.png\" alt=\"mongodb picking shared, aws and region\" srcset=\"/static/ce9c4c24088c7122099309a59a450d08/772e8/mongo2.png 200w,\n/static/ce9c4c24088c7122099309a59a450d08/e17e5/mongo2.png 400w,\n/static/ce9c4c24088c7122099309a59a450d08/5a190/mongo2.png 800w,\n/static/ce9c4c24088c7122099309a59a450d08/c1b63/mongo2.png 1200w,\n/static/ce9c4c24088c7122099309a59a450d08/fba00/mongo2.png 1529w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Esperemos a que el clúster esté listo para su uso. Esto puede llevar algunos minutos.</p>\n<p><strong>NB</strong> No continúes antes de que el clúster esté listo.</p>\n<p>Usemos la pestaña <i>security</i> para crear credenciales de usuario para la base de datos. Ten en cuenta que estas no son las mismas credenciales que utilizas para iniciar sesión en MongoDB Atlas. Estas se usarán para que tu aplicación se conecte a la base de datos.</p>\n<picture><img src=\"/static/123732e6dc0886518b920c2b7a70a675/5a190/mongo3.png\" alt=\"mongodb security quickstart\" srcset=\"/static/123732e6dc0886518b920c2b7a70a675/772e8/mongo3.png 200w,\n/static/123732e6dc0886518b920c2b7a70a675/e17e5/mongo3.png 400w,\n/static/123732e6dc0886518b920c2b7a70a675/5a190/mongo3.png 800w,\n/static/123732e6dc0886518b920c2b7a70a675/c1b63/mongo3.png 1200w,\n/static/123732e6dc0886518b920c2b7a70a675/f4b34/mongo3.png 1457w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>A continuación, debemos definir las direcciones IP que tienen permitido el acceso a la base de datos. Por simplicidad, permitiremos el acceso desde todas las direcciones IP:</p>\n<picture><img src=\"/static/c25b097cd7a4121ead0fc51ea9eca41c/5a190/mongo4.png\" alt=\"mongodb network access/add ip access list\" srcset=\"/static/c25b097cd7a4121ead0fc51ea9eca41c/772e8/mongo4.png 200w,\n/static/c25b097cd7a4121ead0fc51ea9eca41c/e17e5/mongo4.png 400w,\n/static/c25b097cd7a4121ead0fc51ea9eca41c/5a190/mongo4.png 800w,\n/static/c25b097cd7a4121ead0fc51ea9eca41c/78797/mongo4.png 1125w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Nota: En caso de que el menú modal sea diferente para ti, según la documentación de MongoDB, agregar 0.0.0.0 como una IP permite el acceso desde cualquier lugar.</p>\n<p>Finalmente, estamos listos para conectarnos a nuestra base de datos. Comienza haciendo clic en <i>connect</i>:</p>\n<picture><img src=\"/static/4c27952c9018ceba1466ab0ec223c35a/5a190/mongo5.png\" alt=\"mongodb database deployment connect\" srcset=\"/static/4c27952c9018ceba1466ab0ec223c35a/772e8/mongo5.png 200w,\n/static/4c27952c9018ceba1466ab0ec223c35a/e17e5/mongo5.png 400w,\n/static/4c27952c9018ceba1466ab0ec223c35a/5a190/mongo5.png 800w,\n/static/4c27952c9018ceba1466ab0ec223c35a/c1b63/mongo5.png 1200w,\n/static/4c27952c9018ceba1466ab0ec223c35a/07a9c/mongo5.png 1440w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>y elige: <i>Connect to your application</i>:</p>\n<picture><img src=\"/static/c5263c7ff5c69b9ba60c08a9fc7054cb/5a190/mongo6.png\" alt=\"mongodb connect application\" srcset=\"/static/c5263c7ff5c69b9ba60c08a9fc7054cb/772e8/mongo6.png 200w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/e17e5/mongo6.png 400w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/5a190/mongo6.png 800w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/c1b63/mongo6.png 1200w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/10ab7/mongo6.png 1552w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>La vista muestra el <i>MongoDB URI</i>, que es la dirección de la base de datos que proporcionaremos a la librearía de cliente de MongoDB que agregaremos a nuestra aplicación.</p>\n<p>La dirección se ve así:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">mongodb<span class=\"token operator\">+</span>srv<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>fullstack<span class=\"token operator\">:</span>thepasswordishere@cluster0<span class=\"token punctuation\">.</span>o1opl<span class=\"token punctuation\">.</span>mongodb<span class=\"token punctuation\">.</span>net<span class=\"token operator\">/</span><span class=\"token operator\">?</span>retryWrites<span class=\"token operator\">=</span><span class=\"token boolean\">true</span><span class=\"token operator\">&amp;</span>w<span class=\"token operator\">=</span>majority</code></pre></div>\n<p>Ahora estamos listos para usar la base de datos.</p>\n<p>Podríamos usar la base de datos directamente desde nuestro código JavaScript con la librería de <a href=\"https://mongodb.github.io/node-mongodb-native/\">controladores oficial MongoDb Node.js</a>, pero es bastante engorroso de usar. En su lugar, usaremos la librería <a href=\"http://mongoosejs.com/index.html\">Mongoose</a> que ofrece una API de nivel superior.</p>\n<p>Mongoose podría describirse como un <i>object document mapper</i> (ODM) o mapeador de objetos a documentos en castellano, guardar objetos JavaScript como documentos en Mongo es sencillo con esta libería.</p>\n<p>Instalemos Mongoose:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> mongoose</code></pre></div>\n<p>No agreguemos ningún código relacionado con Mongo a nuestro backend por el momento. En cambio, hagamos una aplicación de práctica creando un nuevo archivo, <i>mongo.js</i> en la raíz del backend de la aplicación de notas:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">.</span>length<span class=\"token operator\">&lt;</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'give password as argument'</span><span class=\"token punctuation\">)</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mongodb+srv://fullstack:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>password<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@cluster0.o1opl.mongodb.net/?retryWrites=true&amp;w=majority</span><span class=\"token template-punctuation string\">`</span></span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'strictQuery'</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> <span class=\"token string\">'HTML is easy'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nnote<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note saved!'</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>NB:</strong> Dependiendo de la región que seleccionaste al crear tu clúster, el <i>MongoDB URI</i> puede ser diferente al del ejemplo proporcionado anteriormente. Debes verificar y usar el URI correcto que se generó a partir de MongoDB Atlas.</p>\n<p>El código también asume que se le pasará la contraseña de las credenciales que creamos en MongoDB Atlas, como un parámetro de línea de comando. Podemos acceder al parámetro de la línea de comandos así:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Cuando el código se ejecuta con el comando <i>node mongo.js yourPassword</i>, Mongo agregará un nuevo documento a la base de datos.</p>\n<p><strong>NB:</strong> Ten en cuenta que la contraseña es la contraseña creada para el usuario de la base de datos, no su contraseña de MongoDB Atlas. Además, si creaste una contraseña con caracteres especiales, deberas <a href=\"https://docs.atlas.mongodb.com/troubleshoot-connection/#special-characters-in-connection-string-password\">codificar esa contraseña en la URL</a>.</p>\n<p>Podemos ver el estado actual de la base de datos en MongoDB Atlas desde <i>Browse collections</i>, en la pestaña Database.</p>\n<picture><img src=\"/static/b92e7638ef07610e97be0f557a4d644d/5a190/mongo7.png\" alt=\"Botón para explorar colecciones en las bases de datos de MongoDB\" srcset=\"/static/b92e7638ef07610e97be0f557a4d644d/772e8/mongo7.png 200w,\n/static/b92e7638ef07610e97be0f557a4d644d/e17e5/mongo7.png 400w,\n/static/b92e7638ef07610e97be0f557a4d644d/5a190/mongo7.png 800w,\n/static/b92e7638ef07610e97be0f557a4d644d/c1b63/mongo7.png 1200w,\n/static/b92e7638ef07610e97be0f557a4d644d/0d0e4/mongo7.png 1230w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Según la vista, el <i>documento</i> que coincide con la nota se ha añadido a la colección <i>notes</i> en la base de datos <i>myFirstDatabase</i>.</p>\n<picture><img src=\"/static/2085cdc4f6c22271326e739af65640de/5a190/mongo8new.png\" alt=\"Pestaña de colecciones de MongoDB en la base de datos myfirst app notes\" srcset=\"/static/2085cdc4f6c22271326e739af65640de/772e8/mongo8new.png 200w,\n/static/2085cdc4f6c22271326e739af65640de/e17e5/mongo8new.png 400w,\n/static/2085cdc4f6c22271326e739af65640de/5a190/mongo8new.png 800w,\n/static/2085cdc4f6c22271326e739af65640de/c1b63/mongo8new.png 1200w,\n/static/2085cdc4f6c22271326e739af65640de/bb543/mongo8new.png 1418w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Destruyamos la base de datos predeterminada <i>test</i> y cambiemos el nombre de la base de datos referenciada en nuestra cadena de conexión a <i>noteApp</i>, modificando la URI:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mongodb+srv://fullstack:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>password<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@cluster0.o1opl.mongodb.net/noteApp?retryWrites=true&amp;w=majority</span><span class=\"token template-punctuation string\">`</span></span></code></pre></div>\n<p>Ejecutemos nuestro código de nuevo.</p>\n<picture><img src=\"/static/9bdc595af70c904731fa90e1e4a89242/5a190/mongo9.png\" alt=\"Pestaña de colecciones de MongoDB en la base de datos noteApp con la colección notes\" srcset=\"/static/9bdc595af70c904731fa90e1e4a89242/772e8/mongo9.png 200w,\n/static/9bdc595af70c904731fa90e1e4a89242/e17e5/mongo9.png 400w,\n/static/9bdc595af70c904731fa90e1e4a89242/5a190/mongo9.png 800w,\n/static/9bdc595af70c904731fa90e1e4a89242/c1b63/mongo9.png 1200w,\n/static/9bdc595af70c904731fa90e1e4a89242/bb543/mongo9.png 1418w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Los datos ahora se almacenan en la base de datos correcta. La vista también ofrece la función de <i>create database</i>, que se puede utilizar para crear nuevas bases de datos desde el sitio web. No es necesario crear la base de datos de esta manera, ya que MongoDB Atlas crea automáticamente una nueva base de datos cuando una aplicación intenta conectarse a una base de datos que aún no existe.</p>\n<h3>Schema</h3>\n<p>Después de establecer la conexión a la base de datos, definimos el <a href=\"http://mongoosejs.com/docs/guide.html\">esquema</a> para una nota y el <a href=\"http://mongoosejs.com/docs/models.html\">modelo</a> correspondiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Primero definimos el <a href=\"http://mongoosejs.com/docs/guide.html\">esquema</a> de una nota que se almacena en la variable <em>noteSchema</em>. El esquema le dice a Mongoose cómo se almacenarán los objetos de nota en la base de datos.</p>\n<p>En la definición del modelo <em>Note</em>, el primer parámetro de <i>\"Note\"</i> es el nombre singular del modelo. El nombre de la colección será el plural <i>notes</i> en minúsculas, porque la <a href=\"http://mongoosejs.com/docs/models.html\">convención de Mongoose</a> es nombrar automáticamente las colecciones como el plural (por ejemplo, <i>notes</i>) cuando el esquema se refiere a ellas en singular (por ejemplo, <i>Note</i>).</p>\n<p>Las bases de datos de documentos como Mongo <i>no tienen esquema</i>, lo que significa que la base de datos en sí no se preocupa por la estructura de los datos que se almacenan en la base de datos. Es posible almacenar documentos con campos completamente diferentes en la misma colección.</p>\n<p>La idea detrás de Mongoose es que los datos almacenados en la base de datos reciben un <i>esquema al nivel de la aplicación</i> que define la forma de los documentos almacenados en una colección determinada.</p>\n<h3>Crear y guardar objetos</h3>\n<p>A continuación, la aplicación crea un nuevo objeto de nota con la ayuda del <a href=\"http://mongoosejs.com/docs/models.html\">modelo</a> <i>Note</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> <span class=\"token string\">'HTML is Easy'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Los modelos son <i>funciones constructoras</i> que crean nuevos objetos JavaScript basados ​​en los parámetros proporcionados. Dado que los objetos se crean con la función constructora del modelo, tienen todas las propiedades del modelo, que incluyen métodos para guardar el objeto en la base de datos.</p>\n<p>Guardar el objeto en la base de datos ocurre con el método <em>save</em>, que se puede proporcionar con un controlador de eventos con el método <em>then</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note saved!'</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Cuando el objeto se guarda en la base de datos, el controlador de eventos proporcionado a <em>then</em> se invoca. El controlador de eventos cierra la conexión de la base de datos con el comando <code>mongoose.connection.close()</code>. Si la conexión no se cierra, el programa nunca terminará su ejecución.</p>\n<p>El resultado de la operación de guardar está en el parámetro <em>result</em> del controlador de eventos. El resultado no es tan interesante cuando almacenamos un objeto en la base de datos. Puedes imprimir el objeto en la consola si deseas verlo más de cerca mientras implementas tu aplicación o durante la depuración.</p>\n<p>Guardemos también algunas notas más modificando los datos en el código y ejecutando el programa nuevamente.</p>\n<p><strong>NB:</strong> Desafortunadamente, la documentación de Mongoose no es muy consistente, con partes de ella usando callbacks en sus ejemplos y otras partes, otros estilos, por lo que no se recomienda copiar y pegar código directamente desde allí. No se recomienda mezclar promesas con callbacks de la vieja escuela en el mismo código.</p>\n<h3>Obteniendo objetos de la base de datos</h3>\n<p>Comentemos el código para generar nuevas notas y reemplázalo con lo siguiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  result<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Cuando se ejecuta el código, el programa imprime todas las notas almacenadas en la base de datos:</p>\n<picture><img src=\"/static/e71d12d6187f8507bbbe598b9cef6972/5a190/70new.png\" alt=\"salida de notes como JSON al ejecutar el comando node mongo.js\" srcset=\"/static/e71d12d6187f8507bbbe598b9cef6972/772e8/70new.png 200w,\n/static/e71d12d6187f8507bbbe598b9cef6972/e17e5/70new.png 400w,\n/static/e71d12d6187f8507bbbe598b9cef6972/5a190/70new.png 800w,\n/static/e71d12d6187f8507bbbe598b9cef6972/18539/70new.png 1074w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Los objetos se recuperan de la base de datos con el método <a href=\"https://mongoosejs.com/docs/api.html#model_Model.find\">find</a> del modelo <em>Note</em>. El parámetro del método es un objeto que expresa condiciones de búsqueda. Dado que el parámetro es un objeto vacío <code>{}</code>, obtenemos todas las notas almacenadas en la colección <em>notes</em>.</p>\n<p>Las condiciones de búsqueda se adhieren a la <a href=\"https://www.mongodb.com/docs/manual/tutorial/query-documents/\">sintaxis</a> de consulta de búsqueda de Mongo.</p>\n<p>Podríamos restringir nuestra búsqueda para incluir solo notas importantes de la siguiente manera:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</div>\n<div class=\"tasks\">\n<h3>Ejercicio 3.12.</h3>\n<h4>3.12: Base de datos de línea de comandos</h4>\n<p>Crea una base de datos MongoDB basada en la nube para la aplicación de agenda telefónica con MongoDB Atlas.</p>\n<p>Crea un archivo <i>mongo.js</i> en el directorio del proyecto, que se puede usar para agregar entradas a la agenda y para enumerar todas las entradas existentes en la agenda.</p>\n<p><strong>NB:</strong> ¡No incluyas la contraseña en el archivo que subes a GitHub!</p>\n<p>La aplicación debería funcionar de la siguiente manera. Utiliza el programa pasando tres argumentos de línea de comando (el primero es la contraseña), por ejemplo:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js yourpassword Anna 040-1234556</code></pre></div>\n<p>Como resultado, la aplicación imprimirá:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">added Anna number 040-1234556 to phonebook</code></pre></div>\n<p>La nueva entrada a la agenda telefónica se guardará en la base de datos. Ten en cuenta que si el nombre contiene espacios en blanco, debe ir entre comillas:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js yourpassword <span class=\"token string\">\"Arto Vihavainen\"</span> 045-1232456</code></pre></div>\n<p>Si la contraseña es el único parámetro dado al programa, lo que significa que se invoca así:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js yourpassword</code></pre></div>\n<p>Entonces el programa debería mostrar todas las entradas en la agenda:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">phonebook:\nAnna 040-1234556\nArto Vihavainen 045-1232456\nAda Lovelace 040-1231236</code></pre></div>\n<p>Puedes obtener los parámetros de la línea de comandos de la variable <a href=\"https://nodejs.org/docs/latest-v18.x/api/process.html#process_process_argv\">process.argv</a>.</p>\n<p><strong>NB: no cierres la conexión en el lugar incorrecto</strong>. Por ejemplo, el siguiente código no funcionará:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Person\n  <span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">persons</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>En el código anterior, el comando <i>mongoose.connection.close()</i> se ejecutará inmediatamente después de que se inicie la operación <i>Person.find</i>. Esto significa que la conexión a la base de datos se cerrará inmediatamente y la ejecución nunca llegará al punto en el que finalice la operación <i>Person.find</i> y se llame a la función <i>callback</i>.</p>\n<p>El lugar correcto para cerrar la conexión de la base de datos es al final de la función callback:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Person\n  <span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">persons</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>NB:</strong> Si defines un modelo con el nombre <i>Person</i>, mongoose nombrará automáticamente la colección asociada como <i>people</i>.</p>\n</div>\n<div class=\"content\">\n<h3>Backend conectado a una base de datos</h3>\n<p>Ahora tenemos suficiente conocimiento para comenzar a usar Mongo en nuestra aplicación.</p>\n<p>Comencemos rápidamente copiando y pegando las definiciones de Mongoose en el archivo <i>index.js</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">// DO NOT SAVE YOUR PASSWORD TO GITHUB!!</span>\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mongodb+srv://fullstack:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>password<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@cluster0.o1opl.mongodb.net/?retryWrites=true&amp;w=majority</span><span class=\"token template-punctuation string\">`</span></span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'strictQuery'</span><span class=\"token punctuation\">,</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Cambiemos el controlador para obtener todas las notas al siguiente formato:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">notes</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Podemos verificar en el navegador que el backend funciona para mostrar todos los documentos:</p>\n<picture><img src=\"/static/321bffdcfa60d9fef6fefe5578eb4791/5a190/44ea.png\" alt=\"api/notes en el navegador muestra notas en JSON\" srcset=\"/static/321bffdcfa60d9fef6fefe5578eb4791/772e8/44ea.png 200w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/e17e5/44ea.png 400w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/5a190/44ea.png 800w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/c1b63/44ea.png 1200w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/29007/44ea.png 1600w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/5eb90/44ea.png 1612w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>La aplicación funciona casi a la perfección. El frontend asume que cada objeto tiene un id único en el campo de <i>id</i>. Tampoco queremos retornar el campo de control de versiones de mongo <i>__v</i> al frontend.</p>\n<p>Una forma de formatear los objetos devueltos por Mongoose es <a href=\"https://stackoverflow.com/questions/7034848/mongodb-output-id-instead-of-id\">modificar</a> el método <em>toJSON</em> del esquema, que se utiliza en todas las instancias de los modelos producidos con ese esquema.</p>\n<p>Para modificar el método, necesitamos cambiar las opciones configurables del esquema. Las opciones se pueden cambiar utilizando el método set del esquema. Consulta aquí para obtener más información sobre este método: <a href=\"https://mongoosejs.com/docs/guide.html#options\">https://mongoosejs.com/docs/guide.html#options</a>. Consulta <a href=\"https://mongoosejs.com/docs/guide.html#toJSON\">https://mongoosejs.com/docs/guide.html#toJSON</a> y <a href=\"https://mongoosejs.com/docs/api.html#document_Document-toObject\">https://mongoosejs.com/docs/api.html#document_Document-toObject</a> para obtener más información sobre la opción <em>toJSON</em>.</p>\n<p>Consulta <a href=\"https://mongoosejs.com/docs/api/document.html#transform\">https://mongoosejs.com/docs/api/document.html#transform</a> para obtener más información sobre la función <em>transform</em>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">noteSchema<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toJSON'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">transform</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">document<span class=\"token punctuation\">,</span> returnedObject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    returnedObject<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> returnedObject<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>_id\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>__v\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Aunque la propiedad <i>_id</i> de los objetos Mongoose parece un string, de hecho es un objeto. El método <em>toJSON</em> que definimos lo transforma en un string solo para estar seguros. Si no hiciéramos este cambio, nos causaría más daño en el futuro una vez que comencemos a escribir pruebas.</p>\n<p>No es necesario hacer cambios en el controlador:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">notes</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>El código utiliza automáticamente el <em>toJSON</em> definido al formatear las notas para la respuesta.</p>\n<h3>Moviendo la configuración de la base de datos a su propio módulo</h3>\n<p>Antes de refactorizar el resto del backend para usar la base de datos, extraigamos el código específico de Mongoose en su propio módulo.</p>\n<p>Creemos un nuevo directorio para el módulo llamado <i>models</i> y agreguemos un archivo llamado <i>note.js</i>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'strictQuery'</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MONGODB_URI</span></span>\n<span class=\"gatsby-highlight-code-line\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connecting to'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span></span>\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected to MongoDB'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error connecting to MongoDB:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nnoteSchema<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toJSON'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">transform</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">document<span class=\"token punctuation\">,</span> returnedObject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    returnedObject<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> returnedObject<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>_id\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>__v\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></span></code></pre></div>\n<p>La definición de <a href=\"https://nodejs.org/docs/latest-v18.x/api/modules.html\">módulos</a> de Node difiere ligeramente de la forma de definir <a href=\"/es/part2/renderizando_una_coleccion_modulos#refactorizando-modulos\">módulos ES6</a> en la parte 2.</p>\n<p>La interfaz pública del módulo se define estableciendo un valor en la variable <em>module.exports</em>. Estableceremos el valor para que sea el modelo <i>Note</i>. Las otras cosas definidas dentro del módulo, como las variables <em>mongoose</em> y <em>url</em>, no serán accesibles ni visibles para los usuarios del módulo.</p>\n<p>La importación del módulo ocurre agregando la siguiente línea a <i>index.js</i> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./models/note'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>De esta forma la variable <em>Note</em> se asignará al mismo objeto que defina el módulo.</p>\n<p>La forma en que se realiza la conexión ha cambiado ligeramente:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MONGODB_URI</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connecting to'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected to MongoDB'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error connecting to MongoDB:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>No es una buena idea codificar la dirección de la base de datos en el código, por lo que la dirección de la base de datos se pasa a la aplicación a través de la variable de entorno <em>MONGODB_URI</em>.</p>\n<p>El método para establecer la conexión ahora tiene funciones para lidiar con un intento de conexión exitoso y no exitoso. Ambas funciones simplemente registran un mensaje en la consola sobre el estado de éxito:</p>\n<picture><img src=\"/static/b7b715296b130693831cc719ea8d2f99/5a190/45e.png\" alt=\"salida de node cuando se pasa username/password erroneo\" srcset=\"/static/b7b715296b130693831cc719ea8d2f99/772e8/45e.png 200w,\n/static/b7b715296b130693831cc719ea8d2f99/e17e5/45e.png 400w,\n/static/b7b715296b130693831cc719ea8d2f99/5a190/45e.png 800w,\n/static/b7b715296b130693831cc719ea8d2f99/c1b63/45e.png 1200w,\n/static/b7b715296b130693831cc719ea8d2f99/35890/45e.png 1582w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Hay muchas formas de definir el valor de una variable de entorno. Una forma sería definirlo cuando se inicia la aplicación:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">MONGODB_URI</span><span class=\"token operator\">=</span>address_here <span class=\"token function\">npm</span> run dev</code></pre></div>\n<p>Una forma más sofisticada es utilizar la librería <a href=\"https://github.com/motdotla/dotenv#readme\">dotenv</a>. Puedes instalar la librería con el comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> dotenv</code></pre></div>\n<p>Para usar la librería, creamos un archivo <i>.env</i> en la raíz del proyecto. Las variables de entorno se definen dentro del archivo y pueden verse así:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">MONGODB_URI</span><span class=\"token operator\">=</span>mongodb+srv://fullstack:thepasswordishere@cluster0.o1opl.mongodb.net/noteApp?retryWrites<span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">w</span><span class=\"token operator\">=</span>majority\n<span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3001</span></code></pre></div>\n<p>También agregamos el puerto codificado del servidor en la variable de entorno <em>PORT</em>.</p>\n<p><strong>El archivo <i>.env</i> debe ignorarse de inmediato en .gitignore, ¡ya que no queremos publicar ninguna información confidencial públicamente!</strong></p>\n<picture><img src=\"/static/e12482f21c1bd50aaa9fa2e9a85169f1/5a190/45ae.png\" alt=\".gitignore en vscode con .env añadido\" srcset=\"/static/e12482f21c1bd50aaa9fa2e9a85169f1/772e8/45ae.png 200w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/e17e5/45ae.png 400w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/5a190/45ae.png 800w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/c1b63/45ae.png 1200w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/f2f8c/45ae.png 1490w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Las variables de entorno definidas en el archivo <i>.env</i> se pueden utilizar con la expresión <em>require('dotenv').config()</em> y puedes referenciarlas en tu código como lo harías con las variables de entorno normales, con la sintaxis <em>process.env.MONGODB_URI</em>.</p>\n<p>Cambiemos el archivo <i>index.js</i> de la siguiente manera:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./models/note'</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token comment\">// ..</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span></span>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Es importante que <i>dotenv</i> se importe antes de importar el modelo <i>note</i>. Esto asegura que las variables de entorno del archivo <i>.env</i> estén disponibles globalmente antes de que se importe el código de los otros módulos.</p>\n<h3>Nota importante para usuarios de Fly.io</h3>\n<p>Debido a que GitHub no se utiliza con Fly.io, el archivo .env también se copia a los servidores de Fly.io cuando se despliega la aplicación. Debido a esto, las variables de entorno definidas en el archivo estarán disponibles allí.</p>\n<p>Sin embargo, una <a href=\"https://community.fly.io/t/clarification-on-environment-variables/6309\">mejor opción</a> es evitar que .env se copie a Fly.io creando en la raíz del proyecto el archivo <em>.dockerignore</em>, con el siguiente contenido:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">.env</code></pre></div>\n<p>y estableciendo el valor de la variable de entorno desde la línea de comandos con el comando:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">fly secrets <span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">MONGODB_URI</span><span class=\"token operator\">=</span><span class=\"token string\">\"mongodb+srv://fullstack:thepasswordishere@cluster0.o1opl.mongodb.net/noteApp?retryWrites=true&amp;w=majority\"</span></code></pre></div>\n<p>Dado que PORT también está definido en nuestro archivo .env, es esencial ignorar el archivo en Fly.io, ya que de lo contrario, la aplicación se inicia en el puerto incorrecto.</p>\n<p>Al utilizar Render, la URL de la base de datos se proporciona definiendo la variable de entorno adecuada en el panel de control:</p>\n<picture><img src=\"/static/ae7c73092becbbef8aa45299e9b8fbcd/5a190/render-env.png\" alt=\"navegador mostrando variables de entorno de Render\" srcset=\"/static/ae7c73092becbbef8aa45299e9b8fbcd/772e8/render-env.png 200w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/e17e5/render-env.png 400w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/5a190/render-env.png 800w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/c1b63/render-env.png 1200w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/29007/render-env.png 1600w,\n/static/ae7c73092becbbef8aa45299e9b8fbcd/97a96/render-env.png 2400w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Solo establece a la URL comenzando con <i>mongodb+srv://...</i> al campo <em>value</em>.</p>\n<h3>Usando la base de datos en los controladores de ruta</h3>\n<p>A continuación, cambiemos el resto de la funcionalidad del backend para usar la base de datos.</p>\n<p>La creación de una nueva nota se logra así:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'content missing'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">savedNote</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Los objetos de nota se crean con la función de constructor <em>Note</em>. La respuesta se envía dentro de la función callback para la operación <em>save</em>. Esto asegura que la respuesta se envíe solo si la operación se realizó correctamente. Discutiremos el manejo de errores un poco más adelante.</p>\n<p>El parámetro <em>savedNote</em> en la función callback es la nota guardada y recién creada. Los datos devueltos en la respuesta son la versión formateada creada con el método <em>toJSON</em> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Usando el método <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findById\">findById</a> de Mongoose, la obtención de una nota individual se cambia a lo siguiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Verificación de la integración de frontend y backend</h3>\n<p>Cuando el backend se expande, es una buena idea probar el backend primero con <strong>el navegador, Postman o el cliente REST de VS Code</strong>. A continuación, intentemos crear una nueva nota después de utilizar la base de datos:</p>\n<picture><img src=\"/static/b0e29107aaf7510cebfd5fe29518fc92/5a190/46new.png\" alt=\"VS code cliente rest haciendo un post\" srcset=\"/static/b0e29107aaf7510cebfd5fe29518fc92/772e8/46new.png 200w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/e17e5/46new.png 400w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/5a190/46new.png 800w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/c1b63/46new.png 1200w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/29007/46new.png 1600w,\n/static/b0e29107aaf7510cebfd5fe29518fc92/720e3/46new.png 1962w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Solo una vez que se haya verificado que todo funciona en el backend, es una buena idea probar que el frontend funciona con el backend. Es muy ineficiente probar cosas exclusivamente a través del frontend.</p>\n<p>Probablemente sea una buena idea integrar el frontend y el backend una funcionalidad a la vez. Primero, podríamos implementar la búsqueda de todas las notas de la base de datos y probarlas a través del endpoint de backend en el navegador. Después de esto, podríamos verificar que el frontend funciona con el nuevo backend. Una vez que todo parezca funcionar, pasaríamos a la siguiente funcionalidad.</p>\n<p>Una vez que introducimos una base de datos en la mezcla, es útil inspeccionar el estado persistente en la base de datos, por ejemplo, desde el panel de control en MongoDB Atlas. Muy a menudo, los pequeños programas auxiliares de Node como el programa <i>mongo.js</i> que escribimos anteriormente pueden ser muy útiles durante el desarrollo.</p>\n<p>Puedes encontrar el código para nuestra aplicación actual en su totalidad en la rama <i>part3-4</i> de <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-4\">este repositorio de GitHub</a>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Ejercicios 3.13.-3.14.</h3>\n<p>Los siguientes ejercicios son bastante sencillos, pero si tu frontend deja de funcionar con el backend, entonces encontrar y corregir los errores puede ser bastante interesante.</p>\n<h4>3.13: Base de datos de la Agenda Telefónica, paso 1</h4>\n<p>Cambia la búsqueda de todas las entradas de la agenda telefónica para que los datos <i>se obtengan desde la base de datos</i>.</p>\n<p>Verifica que el frontend funcione después de que se hayan realizado los cambios.</p>\n<p>En los siguientes ejercicios, escribe todo el código específico de Mongoose en su propio módulo, como hicimos en el capítulo <a href=\"/es/part3/guardando_datos_en_mongo_db#moviendo-la-configuracion-de-la-base-de-datos-a-su-propio-modulo\">Configuración de la base de datos en su propio módulo</a>.</p>\n<h4>3.14: Base de datos de la Agenda Telefónica, paso 2</h4>\n<p>Cambia el backend para que los nuevos números se <i>guarden en la base de datos</i>. Verifica que tu frontend aún funcione después de los cambios.</p>\n<p>En esta etapa, puedes ignorar si ya existe una persona en la base de datos con el mismo nombre que la persona que estás agregando.</p>\n</div>\n<div class=\"content\">\n<h3>Manejo de errores</h3>\n<p>Si intentamos visitar la URL de una nota con un id que en realidad no existe, por ejemplo, <a href=\"http://localhost:3001/api/notes/5c41c90e84d891c15dfa3431\">http://localhost:3001/api/notes/5c41c90e84d891c15dfa3431</a> donde <i>5c41c90e84d891c15dfa3431</i> no es un id almacenado en la base de datos, entonces la respuesta será <em>null</em>.</p>\n<p>Cambiemos este comportamiento para que si la nota con la identificación dada no existe, el servidor responderá a la solicitud con el código de estado HTTP 404 not found. Además, implementemos un bloque <em>catch</em> sencillo para manejar los casos en los que la promesa devuelta por el método <em>findById</em> es rechazada:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Si no se encuentra ningún objeto coincidente en la base de datos, el valor de <em>note</em> será <em>null</em> y se ejecutará el bloque <em>else</em>. Esto da como resultado una respuesta con el código de estado <i>404 not found</i>. Si se rechaza la promesa retornada por el método <em>findById</em>, la respuesta tendrá el código de estado <i>500 internal server error</i>. La consola muestra información más detallada sobre el error.</p>\n<p>Además de la nota que no existe, hay una situación de error más que debe manejarse. En esta situación, estamos intentando obtener una nota con un tipo de <em>id</em> incorrecto , es decir, un <em>id</em> que no coincide con el formato del identificador de Mongo.</p>\n<p>Si realizamos la siguiente solicitud, obtendremos el mensaje de error que se muestra a continuación:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Method: GET\nPath:   /api/notes/someInvalidId\nBody:   {}\n---\n{ CastError: Cast to ObjectId failed for value \"someInvalidId\" at path \"_id\"\n    at CastError (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/error/cast.js:27:11)\n    at ObjectId.cast (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/schema/objectid.js:158:13)\n    ...</code></pre></div>\n<p>Dado un ID mal formado como argumento, el método <em>findById</em> arrojará un error que provocará el rechazo de la promesa retornada. Esto hará que se llame a la función callback definida en el bloque <em>catch</em>.</p>\n<p>Hagamos algunos pequeños ajustes a la respuesta en el bloque <em>catch</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Si el formato del id es incorrecto, terminaremos en el controlador de errores definido en el bloque <em>catch</em>. El código de estado apropiado para la situación es <a href=\"https://www.rfc-editor.org/rfc/rfc9110.html#name-400-bad-request\">400 Bad Request</a>, porque la situación se ajusta perfectamente a la descripción:</p>\n<blockquote>\n<p><i>El código de estado 400 (Solicitud incorrecta) indica que el servidor no puede o no procesará la solicitud debido a algo que se percibe como un error del cliente (por ejemplo, sintaxis de solicitud incorrecta, formato de mensaje de solicitud inválido o enrutamiento de solicitud engañoso).</i></p>\n</blockquote>\n<p>También hemos agregado algunos datos a la respuesta para arrojar algo de luz sobre la causa del error.</p>\n<p>Cuando se trata de Promesas, casi siempre es una buena idea agregar el manejo de errores y excepciones, porque de lo contrario te encontraras lidiando con errores extraños.</p>\n<p>Nunca es una mala idea imprimir el objeto que causó la excepción a la consola en el controlador de errores:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span></span>  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>La razón por la que se llama al controlador de errores puede ser algo completamente diferente de lo que habías anticipado. Si registras el error en la consola, puedes ahorrarte largas y frustrantes sesiones de depuración. Además, la mayoría de los servicios modernos en los que despliegas tu aplicación admiten algún tipo de sistema de registro que puedes usar para verificar estos registros. Como se mencionó, Fly.io es uno.</p>\n<p>Cada vez que trabajas en un proyecto con un backend, <i>es fundamental estar atento a la salida de la consola del backend</i>. Si estás trabajando en una pantalla pequeña, basta con ver una pequeña porción de la salida en segundo plano. Cualquier mensaje de error llamará tu atención incluso cuando la consola esté muy atrás en segundo plano:</p>\n<picture><img src=\"/static/b5656dca7416a1a37670dc5a51bfbbc7/5a190/15b.png\" alt=\"captura de pantalla mostrando trozo pequeño de salida de consola\" srcset=\"/static/b5656dca7416a1a37670dc5a51bfbbc7/772e8/15b.png 200w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/e17e5/15b.png 400w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/5a190/15b.png 800w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/c1b63/15b.png 1200w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/29007/15b.png 1600w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/966ce/15b.png 2050w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h3>Mover el manejo de errores al middleware</h3>\n<p>Hemos escrito el código para el controlador de errores entre el resto de nuestro código. Esta puede ser una solución razonable a veces, pero hay casos en los que es mejor implementar todo el manejo de errores en un solo lugar. Esto puede ser particularmente útil si más adelante queremos reportar datos relacionados con errores a un sistema de seguimiento de errores externo como <a href=\"https://sentry.io/welcome/\">Sentry</a>.</p>\n<p>Cambiemos el controlador de la ruta <i>/api/notes/:id</i>, para que pase el error hacia adelante con la función <em>next</em>. La función <em>next</em> se pasa al controlador como tercer parámetro:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span>  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>El error que se pasa hacia adelante es dado a la función <em>next</em> como parámetro. Si se llamó a next sin un argumento, entonces la ejecución simplemente pasaría a la siguiente ruta o middleware. Si se llama a la función <em>next</em> con un argumento, la ejecución continuará en el <i>middleware del controlador de errores</i>.</p>\n<p>Los <a href=\"https://expressjs.com/en/guide/error-handling.html\">controladores de errores</a> de Express son middleware que se definen con una función que acepta <i>cuatro parámetros</i>. Nuestro controlador de errores se ve así:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'CastError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> \n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// este debe ser el último middleware cargado, ¡también todas las rutas deben ser registrada antes que esto!</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span></code></pre></div>\n<p>El controlador de errores comprueba si el error es una excepción <i>CastError</i>, en cuyo caso sabemos que el error fue causado por un ID de objeto no válido para Mongo. En esta situación, el controlador de errores enviará una respuesta al navegador con el objeto de respuesta pasado como parámetro. En todas las demás situaciones de error, el middleware pasa el error al controlador de errores Express predeterminado.</p>\n<p>Ten en cuenta que el middleware de manejo de errores debe ser el último middleware cargado, también todas las rutas deben registrarse antes que el error-handler!</p>\n<h3>El orden de carga del middleware</h3>\n<p>El orden de ejecución del middleware es el mismo que el orden en el que se cargan en Express con la función <em>app.use</em>. Por esta razón, es importante tener cuidado al definir el middleware.</p>\n<p>El orden correcto es el siguiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// controlador de solicitudes con endpoint desconocido</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>unknownEndpoint<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// controlador de solicitudes que resulten en errores</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span></code></pre></div>\n<p>El middleware json-parser debería estar entre los primeros middleware cargados en Express. Si el orden fuera el siguiente:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">)</span> <span class=\"token comment\">// request.body es undefined!</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// request.body es undefined!</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Entonces, los datos JSON enviados con las solicitudes HTTP no estarían disponibles para el middleware del registrador o el controlador de ruta POST, ya que <em>request.body</em> estaría <em>undefined</em> en ese punto.</p>\n<p>También es importante que el middleware para manejar rutas no admitidas esté junto al último middleware que se cargó en Express, justo antes del controlador de errores.</p>\n<p>Por ejemplo, el siguiente orden de carga causaría un problema:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// controlador de solicitudes con endpoint desconocido</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>unknownEndpoint<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Ahora, el manejo de los endpoints desconocidos se ordena <i>antes que el controlador de solicitudes HTTP</i>. Dado que el controlador de endpoint desconocido responde a todas las solicitudes con <i>404 unknown endpoint</i>, no se llamará a ninguna ruta o middleware después de que el middleware de endpoint desconocido haya enviado la respuesta. La única excepción a esto es el controlador de errores que debe estar al final, después del controlador de endpoints desconocido.</p>\n<h3>Otras operaciones</h3>\n<p>Agreguemos algunas funcionalidades que faltan a nuestra aplicación, incluida la eliminación y actualización de una nota individual.</p>\n<p>La forma más fácil de eliminar una nota de la base de datos es con el método <a href=\"https://mongoosejs.com/docs/api/model.html#Model.findByIdAndDelete()\">findByIdAndDelete</a>:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndDelete</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">204</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>En los dos casos \"exitosos\" de eliminar un recurso, el backend responde con el código de estado <i>204 no content</i>. Los dos casos diferentes son eliminar una nota que existe y eliminar una nota que no existe en la base de datos. El parámetro callback <em>result</em> podría usarse para verificar si un recurso realmente se eliminó, y podríamos usar esa información para devolver códigos de estado diferentes para los dos casos si lo consideramos necesario. Cualquier excepción que ocurra se pasa al controlador de errores.</p>\n<p>El cambio de la importancia de una nota se puede lograr fácilmente con el método <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndUpdate\">findByIdAndUpdate</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndUpdate</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> note<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">new</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">updatedNote</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>updatedNote<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>En el código anterior, también permitimos que se edite el contenido de la nota.</p>\n<p>Observa que el método <em>findByIdAndUpdate</em> recibe un objeto JavaScript normal como argumento, y no un nuevo objeto de nota creado con la función constructora <em>Note</em>.</p>\n<p>Hay un detalle importante con respecto al uso del método <em>findByIdAndUpdate</em>. De forma predeterminada, el parámetro <em>updatedNote</em> del controlador de eventos recibe el documento original <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndUpdate\">sin las modificaciones</a>. Agregamos el parámetro opcional <code>{ new: true }</code>, que hará que nuestro controlador de eventos sea llamado con el nuevo documento modificado en lugar del original.</p>\n<p>Después de probar el backend directamente con Postman o el cliente REST de VS Code, podemos verificar que parece funcionar. El frontend también parece funcionar con el backend usando la base de datos.</p>\n<p>Puedes encontrar el código para nuestra aplicación actual en su totalidad en la rama <i>part3-5</i> de <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-5\">este repositorio de GitHub</a>.</p>\n<h3>Un verdadero juramento de desarrollador full stack</h3>\n<p>Una vez más, es tiempo para los ejercicios. La complejidad de nuestra aplicación ha dado otro paso, ya que ahora, además del frontend y el backend, también tenemos una base de datos.\nRealmente hay muchas fuentes potenciales de errores.</p>\n<p>Así que debemos extender una vez más nuestro juramento:</p>\n<p>El desarrollo full stack es <i>extremadamente difícil</i>, por eso utilizaré todos los medios posibles para facilitarlo.</p>\n<ul>\n<li>Mantendré la consola de desarrollador del navegador abierta todo el tiempo.</li>\n<li>Utilizaré la pestaña de red de las herramientas de desarrollo del navegador para asegurarme de que el frontend y el backend estén comunicándose como espero.</li>\n<li>Vigilaré constantemente el estado del servidor para asegurarme de que los datos enviados por el frontend se guarden allí como espero.</li>\n<li><i>Observaré la base de datos: ¿guarda el backend los datos allí en el formato correcto?</i></li>\n<li>Progresaré con pequeños pasos.</li>\n<li>Escribiré muchas declaraciones de <em>console.log</em> para asegurarme de entender cómo se comporta el código y ayudar a señalar problemas.</li>\n<li>Si mi código no funciona, no escribiré más código. En su lugar, comenzaré a eliminar código hasta que funcione o simplemente regresaré a un estado en el que todo aún funcionaba.</li>\n<li>Cuando pida ayuda en el canal de Discord del curso o en cualquier otro lugar, formularé mis preguntas correctamente, consulta <a href=\"https://fullstackopen.com/en/part0/general_info#how-to-get-help-in-discord\">aquí</a> cómo pedir ayuda.</li>\n</ul>\n</div>\n<div class=\"tasks\">\n<h3>Ejercicios 3.15.-3.18.</h3>\n<h4>3.15: Base de datos de la Agenda Telefónica, paso 3</h4>\n<p>Cambia el backend para que la eliminación de entradas de la agenda telefónica se refleje en la base de datos.</p>\n<p>Verifica que el frontend aún funcione después de realizar los cambios.</p>\n<h4>3.16: Base de datos de la Agenda Telefónica, paso 4</h4>\n<p>Mueve el manejo de errores de la aplicación a un nuevo middleware de manejo de errores.</p>\n<h4>3.17*: Base de datos de la Agenda Telefónica, paso 5</h4>\n<p>Si el usuario intenta crear una nueva entrada en la agenda para una persona cuyo nombre ya está en la agenda, el frontend intentará actualizar el número de teléfono de la entrada existente realizando una solicitud HTTP PUT a la URL única de la entrada.</p>\n<p>Modifica el backend para admitir esta solicitud.</p>\n<p>Verifica que el frontend funcione después de realizar los cambios.</p>\n<h4>3.18*: Base de datos de la Agenda Telefónica, paso 6</h4>\n<p>También actualiza el manejo de las rutas <i>api/persons/:id</i> e <i>info</i> para usar la base de datos, y verifica que funcionen directamente con el navegador, Postman o el cliente REST de VS Code.</p>\n<p>La inspección de una entrada individual de la agenda telefónica desde el navegador debería verse así:</p>\n<picture><img src=\"/static/853a1d57372a2b5c8fc1249b682d59a7/5a190/49.png\" alt=\"navegador mostrando los datos de una persona en la ruta api/persons/id\" srcset=\"/static/853a1d57372a2b5c8fc1249b682d59a7/772e8/49.png 200w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/e17e5/49.png 400w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/5a190/49.png 800w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/c1b63/49.png 1200w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/c655d/49.png 1586w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n</div>","frontmatter":{"mainImage":{"publicURL":"/static/8ac7bc0fb2b7018a7853b00c454b2103/part-3.svg"},"part":3,"letter":"c","lang":"es"}}},"pageContext":{"part":3,"letter":"c","lang":"es"}},"staticQueryHashes":["3128451518"]}