{"componentChunkName":"component---src-templates-content-template-js","path":"/fr/part3/stocker_des_donnees_sur_mongo_db","result":{"data":{"markdownRemark":{"html":"<div class=\"content\">\n<p>Avant de passer au sujet principal de la persistance des données dans une base de données, nous allons jeter un coup d'oeil à quelques façons différentes de déboguer les applications Node.</p>\n<h3>Débogage des applications Node</h3>\n<p>Le débogage des applications Node est légèrement plus difficile que le débogage du JavaScript exécuté dans votre navigateur. L'impression à la console est une méthode éprouvée et vraie, et cela vaut toujours la peine de la faire. Il y a des gens qui pensent que des méthodes plus sophistiquées devraient être utilisées à la place, mais je ne suis pas d'accord. Même l'élite mondiale des développeurs open source <a href=\"https://tenderlovemaking.com/2016/02/05/i-am-a-puts-debuggerer.html\">utilise</a> cette <a href=\"https://swizec.com/blog/javascript-debugging-slightly-beyond-consolelog/\">méthode</a>.</p>\n<h4>Visual Studio Code</h4>\n<p>Le débogueur de Visual Studio Code peut être utile dans certaines situations. Vous pouvez lancer l'application en mode débogage comme ceci :</p>\n<picture><img src=\"/static/b97b10a73a2a6404f05e73cc9eaff622/5a190/35x.png\" srcset=\"/static/b97b10a73a2a6404f05e73cc9eaff622/772e8/35x.png 200w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/e17e5/35x.png 400w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/5a190/35x.png 800w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/c1b63/35x.png 1200w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/29007/35x.png 1600w,\n/static/b97b10a73a2a6404f05e73cc9eaff622/c658e/35x.png 2202w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Notez que l'application ne doit pas être exécutée dans une autre console, sinon le port sera déjà utilisé.</p>\n<p><strong>NB</strong> Une version plus récente de Visual Studio Code peut avoir <em>Run</em> au lieu de <em>Debug</em>. De plus, vous devrez peut-être configurer votre fichier <em>launch.json</em> pour lancer le débogage. Cela peut être fait en choisissant <em>Add Configuration... _ dans le menu déroulant, qui se trouve à côté du bouton vert de lecture et au-dessus du menu _VARIABLES</em>, et sélectionnez <em>Run \"npm start\" dans un terminal de débogage</em>. Pour des instructions de configuration plus détaillées, consultez la [documentation sur le débogage] de Visual Studio Code (<a href=\"https://code.visualstudio.com/docs/editor/debugging\">https://code.visualstudio.com/docs/editor/debugging</a>).</p>\n<p>Vous pouvez voir ci-dessous une capture d'écran où l'exécution du code a été interrompue au milieu de l'enregistrement d'une nouvelle note :</p>\n<picture><img src=\"/static/feed4fe57ce10ff79881a5cbd155026b/5a190/36x.png\" srcset=\"/static/feed4fe57ce10ff79881a5cbd155026b/772e8/36x.png 200w,\n/static/feed4fe57ce10ff79881a5cbd155026b/e17e5/36x.png 400w,\n/static/feed4fe57ce10ff79881a5cbd155026b/5a190/36x.png 800w,\n/static/feed4fe57ce10ff79881a5cbd155026b/c1b63/36x.png 1200w,\n/static/feed4fe57ce10ff79881a5cbd155026b/29007/36x.png 1600w,\n/static/feed4fe57ce10ff79881a5cbd155026b/7e9b1/36x.png 2252w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>L'exécution s'est arrêtée au <i>point d'arrêt</i> à la ligne 63. Dans la console, vous pouvez voir la valeur de la variable <i>note</i>. Dans la fenêtre en haut à gauche, vous pouvez voir d'autres choses liées à l'état de l'application.</p>\n<p>Les flèches en haut peuvent être utilisées pour contrôler le flux du débogueur.</p>\n<p>Pour une raison quelconque, je n'utilise pas beaucoup le débogueur de Visual Studio Code.</p>\n<h4>Outils de développement de Chrome</h4>\n<p>Le débogage est également possible avec la console de développement de Chrome en démarrant votre application avec la commande :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> <span class=\"token parameter variable\">--inspect</span> index.js</code></pre></div>\n<p>Vous pouvez accéder au débogueur en cliquant sur l'icône verte - le logo de node - qui apparaît dans la console du développeur de Chrome :</p>\n<picture><img src=\"/static/98eea9ee4f184a484417314745f7422a/5a190/37.png\" srcset=\"/static/98eea9ee4f184a484417314745f7422a/772e8/37.png 200w,\n/static/98eea9ee4f184a484417314745f7422a/e17e5/37.png 400w,\n/static/98eea9ee4f184a484417314745f7422a/5a190/37.png 800w,\n/static/98eea9ee4f184a484417314745f7422a/c1b63/37.png 1200w,\n/static/98eea9ee4f184a484417314745f7422a/29007/37.png 1600w,\n/static/98eea9ee4f184a484417314745f7422a/bf286/37.png 1688w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>La vue de débogage fonctionne de la même manière que pour les applications React. L'onglet <i>Sources</i> peut être utilisé pour définir des points d'arrêt où l'exécution du code sera mise en pause.</p>\n<picture><img src=\"/static/55e5f6c8afb83433a723a0da5c575a32/5a190/38eb.png\" srcset=\"/static/55e5f6c8afb83433a723a0da5c575a32/772e8/38eb.png 200w,\n/static/55e5f6c8afb83433a723a0da5c575a32/e17e5/38eb.png 400w,\n/static/55e5f6c8afb83433a723a0da5c575a32/5a190/38eb.png 800w,\n/static/55e5f6c8afb83433a723a0da5c575a32/c1b63/38eb.png 1200w,\n/static/55e5f6c8afb83433a723a0da5c575a32/29007/38eb.png 1600w,\n/static/55e5f6c8afb83433a723a0da5c575a32/828bd/38eb.png 2310w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Tous les messages <i>console.log</i> de l'application apparaîtront dans l'onglet <i>Console</i> du débogueur. Vous pouvez également inspecter les valeurs des variables et exécuter votre propre code JavaScript.</p>\n<picture><img src=\"/static/f4ab60bfb4c362e50561a48eb231a212/5a190/39ea.png\" srcset=\"/static/f4ab60bfb4c362e50561a48eb231a212/772e8/39ea.png 200w,\n/static/f4ab60bfb4c362e50561a48eb231a212/e17e5/39ea.png 400w,\n/static/f4ab60bfb4c362e50561a48eb231a212/5a190/39ea.png 800w,\n/static/f4ab60bfb4c362e50561a48eb231a212/c1b63/39ea.png 1200w,\n/static/f4ab60bfb4c362e50561a48eb231a212/29007/39ea.png 1600w,\n/static/f4ab60bfb4c362e50561a48eb231a212/baa75/39ea.png 1746w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h4>Questionnez tout</h4>\n<p>Le débogage des applications Full Stack peut sembler délicat au début. Bientôt, notre application aura également une base de données en plus du frontend et du backend, et il y aura de nombreuses zones potentielles de bugs dans l'application.</p>\n<p>Lorsque l'application \"ne fonctionne pas\", nous devons d'abord déterminer où le problème se situe réellement. Il est très fréquent que le problème se trouve à un endroit où vous ne vous y attendiez pas, et il peut se passer des minutes, des heures, voire des jours avant que vous ne trouviez la source du problème.</p>\n<p>La clé est d'être systématique. Puisque le problème peut exister n'importe où, <i>vous devez tout remettre en question</i>, et éliminer toutes les possibilités une par une. La journalisation sur la console, Postman, les débogueurs et l'expérience vous aideront.</p>\n<p>Lorsque des bugs surviennent, <i>la pire des stratégies possibles</i> est de continuer à écrire du code. Cela garantira que votre code aura bientôt encore plus de bugs, et que leur débogage sera encore plus difficile. Le principe <a href=\"http://gettingtolean.com/toyota-principle-5-build-culture-stopping-fix/\">stop and fix</a> du Toyota Production Systems est également très efficace dans cette situation.</p>\n<h3>MongoDB</h3>\n<p>Afin de stocker indéfiniment nos notes enregistrées, nous avons besoin d'une base de données. La plupart des cours dispensés à l'Université d'Helsinki utilisent des bases de données relationnelles. Dans la majeure partie de ce cours, nous utiliserons <a href=\"https://www.mongodb.com/\">MongoDB</a> qui est une base de données documentaire (<a href=\"https://en.wikipedia.org/wiki/Document-oriented_database\">https://en.wikipedia.org/wiki/Document-oriented_database</a>).</p>\n<p>La raison de l'utilisation de Mongo comme base de données est sa moindre complexité par rapport à une base de données relationnelle. <a href=\"https://fullstackopen.com/en/part13\">La partie 13</a> du cours montre comment construire des backends node.js qui utilisent une base de données relationnelle.</p>\n<p>Les bases de données documentaires diffèrent des bases de données relationnelles par la manière dont elles organisent les données ainsi que par les langages d'interrogation qu'elles prennent en charge. Les bases de données documentaires sont généralement classées sous le terme générique <a href=\"https://en.wikipedia.org/wiki/NoSQL\">NoSQL</a>.</p>\n<p>Pour en savoir plus sur les bases de données documentaires et les bases de données NoSQL, consultez le support de cours de la <a href=\"https://tikape-s18.mooc.fi/part7/\">semaine 7</a> du cours Introduction aux bases de données. Malheureusement, ce matériel n'est actuellement disponible qu'en finnois. </p>\n<p>Lisez maintenant les chapitres sur les <a href=\"https://docs.mongodb.com/manual/core/databases-and-collections/\">collections</a> et les <a href=\"https://docs.mongodb.com/manual/core/document/\">documents</a> du manuel MongoDB pour avoir une idée de base sur la façon dont une base de données de documents stocke les données.</p>\n<p>Naturellement, vous pouvez installer et exécuter MongoDB sur votre propre ordinateur. Cependant, l'Internet regorge également de services de base de données Mongo que vous pouvez utiliser. Notre fournisseur MongoDB préféré dans ce cours sera <a href=\"https://www.mongodb.com/atlas/database\">MongoDB Atlas</a>.</p>\n<p>Une fois que vous avez créé et connecté votre compte, commençons par sélectionner l'option gratuite :</p>\n<picture><img src=\"/static/51357385d765c59103d23a83d7faa2ab/5a190/mongo1.png\" srcset=\"/static/51357385d765c59103d23a83d7faa2ab/772e8/mongo1.png 200w,\n/static/51357385d765c59103d23a83d7faa2ab/e17e5/mongo1.png 400w,\n/static/51357385d765c59103d23a83d7faa2ab/5a190/mongo1.png 800w,\n/static/51357385d765c59103d23a83d7faa2ab/c1b63/mongo1.png 1200w,\n/static/51357385d765c59103d23a83d7faa2ab/29007/mongo1.png 1600w,\n/static/51357385d765c59103d23a83d7faa2ab/c9d77/mongo1.png 1964w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Choisissez le fournisseur de cloud et l'emplacement et créez le cluster :</p>\n<picture><img src=\"/static/ce9c4c24088c7122099309a59a450d08/5a190/mongo2.png\" srcset=\"/static/ce9c4c24088c7122099309a59a450d08/772e8/mongo2.png 200w,\n/static/ce9c4c24088c7122099309a59a450d08/e17e5/mongo2.png 400w,\n/static/ce9c4c24088c7122099309a59a450d08/5a190/mongo2.png 800w,\n/static/ce9c4c24088c7122099309a59a450d08/c1b63/mongo2.png 1200w,\n/static/ce9c4c24088c7122099309a59a450d08/fba00/mongo2.png 1529w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Attendons que le cluster soit prêt à être utilisé. Cela peut prendre quelques minutes.</p>\n<p><strong>NB</strong> ne continuez pas avant que le cluster soit prêt.</p>\n<p>Utilisons l'onglet <i>security</i> pour créer les informations d'identification des utilisateurs pour la base de données. Veuillez noter que ce ne sont pas les mêmes informations d'identification que vous utilisez pour vous connecter à MongoDB Atlas. Ils seront utilisés par votre application pour se connecter à la base de données.</p>\n<picture><img src=\"/static/123732e6dc0886518b920c2b7a70a675/5a190/mongo3.png\" srcset=\"/static/123732e6dc0886518b920c2b7a70a675/772e8/mongo3.png 200w,\n/static/123732e6dc0886518b920c2b7a70a675/e17e5/mongo3.png 400w,\n/static/123732e6dc0886518b920c2b7a70a675/5a190/mongo3.png 800w,\n/static/123732e6dc0886518b920c2b7a70a675/c1b63/mongo3.png 1200w,\n/static/123732e6dc0886518b920c2b7a70a675/f4b34/mongo3.png 1457w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p> Ensuite, nous devons définir les adresses IP qui sont autorisées à accéder à la base de données. Pour des raisons de simplicité, nous allons autoriser l'accès à partir de toutes les adresses IP :</p>\n<picture><img src=\"/static/c25b097cd7a4121ead0fc51ea9eca41c/5a190/mongo4.png\" srcset=\"/static/c25b097cd7a4121ead0fc51ea9eca41c/772e8/mongo4.png 200w,\n/static/c25b097cd7a4121ead0fc51ea9eca41c/e17e5/mongo4.png 400w,\n/static/c25b097cd7a4121ead0fc51ea9eca41c/5a190/mongo4.png 800w,\n/static/c25b097cd7a4121ead0fc51ea9eca41c/78797/mongo4.png 1125w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Enfin, nous sommes prêts à nous connecter à notre base de données. Commencez par cliquer sur <i>connect</i> :</p>\n<picture><img src=\"/static/4c27952c9018ceba1466ab0ec223c35a/5a190/mongo5.png\" srcset=\"/static/4c27952c9018ceba1466ab0ec223c35a/772e8/mongo5.png 200w,\n/static/4c27952c9018ceba1466ab0ec223c35a/e17e5/mongo5.png 400w,\n/static/4c27952c9018ceba1466ab0ec223c35a/5a190/mongo5.png 800w,\n/static/4c27952c9018ceba1466ab0ec223c35a/c1b63/mongo5.png 1200w,\n/static/4c27952c9018ceba1466ab0ec223c35a/07a9c/mongo5.png 1440w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>et choisissez <i>Connecter votre application</i> :</p>\n<picture><img src=\"/static/c5263c7ff5c69b9ba60c08a9fc7054cb/5a190/mongo6.png\" srcset=\"/static/c5263c7ff5c69b9ba60c08a9fc7054cb/772e8/mongo6.png 200w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/e17e5/mongo6.png 400w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/5a190/mongo6.png 800w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/c1b63/mongo6.png 1200w,\n/static/c5263c7ff5c69b9ba60c08a9fc7054cb/10ab7/mongo6.png 1552w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>La vue affiche l'<i>URI MongoDB</i>, qui est l'adresse de la base de données que nous allons fournir à la bibliothèque client MongoDB que nous allons ajouter à notre application.</p>\n<p>L'adresse ressemble à ceci :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mongodb+srv://fullstack:<span class=\"token variable\">$thepasswordishere</span>@cluster0.o1opl.mongodb.net/myFirstDatabase?retryWrites<span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">w</span><span class=\"token operator\">=</span>majority</code></pre></div>\n<p>Nous sommes maintenant prêts à utiliser la base de données.</p>\n<p>Nous pourrions utiliser la base de données directement depuis notre code JavaScript avec la bibliothèque <a href=\"https://mongodb.github.io/node-mongodb-native/\">official MongoDb Node.js driver</a>, mais elle est assez lourde à utiliser. Nous utiliserons plutôt la bibliothèque <a href=\"http://mongoosejs.com/index.html\">Mongoose</a> qui offre une API de plus haut niveau.</p>\n<p>Mongoose pourrait être décrit comme un <i>object document mapper</i> (ODM), et l'enregistrement d'objets JavaScript en tant que documents Mongo est simple avec cette bibliothèque.</p>\n<p>Installons Mongoose :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> mongoose</code></pre></div>\n<p> N'ajoutons pas encore de code traitant de Mongo à notre backend. Au lieu de cela, faisons une application d'entraînement en créant un nouveau fichier, <i>mongo.js</i> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Please provide the password as an argument: node mongo.js &lt;password>'</span><span class=\"token punctuation\">)</span>\n process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mongodb+srv://notes-app-full:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>password<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">@cluster1.lvvbt.mongodb.net/?retryWrites=true&amp;w=majority</span><span class=\"token template-punctuation string\">`</span></span>\n\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n <span class=\"token literal-property property\">date</span><span class=\"token operator\">:</span> Date<span class=\"token punctuation\">,</span>\n <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span>\n\nmongoose\n <span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n   console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected'</span><span class=\"token punctuation\">)</span>\n\n   <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n     <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> <span class=\"token string\">'HTML is Easy'</span><span class=\"token punctuation\">,</span>\n     <span class=\"token literal-property property\">date</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n     <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n   <span class=\"token keyword\">return</span> note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n   console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note saved!'</span><span class=\"token punctuation\">)</span>\n   <span class=\"token keyword\">return</span> mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>NB:</strong> Selon la région que vous avez sélectionnée lors de la construction de votre cluster, l'URI <i>MongoDB</i> peut être différent de l'exemple fourni ci-dessus. Vous devez vérifier et utiliser l'URI correct qui a été généré par l'Atlas MongoDB.</p>\n<p>Le code suppose également qu'on lui transmettra le mot de passe des informations d'identification que nous avons créées dans MongoDB Atlas, en tant que paramètre de ligne de commande. Nous pouvons accéder au paramètre de la ligne de commande comme suit :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Lorsque le code est exécuté avec la commande <i>node mongo.js password</i>, Mongo ajoutera un nouveau document à la base de données.</p>\n<p><strong>NB:</strong> Veuillez noter que le mot de passe est le mot de passe créé pour l'utilisateur de la base de données, et non votre mot de passe Atlas MongoDB.  De plus, si vous avez créé un mot de passe avec des caractères spéciaux, vous devrez <a href=\"https://docs.atlas.mongodb.com/troubleshoot-connection/#special-characters-in-connection-string-password\">coder l'URL de ce mot de passe</a>.</p>\n<p>Nous pouvons voir l'état actuel de la base de données dans l'Atlas MongoDB à partir de <i>Browse collections</i>, dans l'onglet Database.</p>\n<picture><img src=\"/static/b92e7638ef07610e97be0f557a4d644d/5a190/mongo7.png\" srcset=\"/static/b92e7638ef07610e97be0f557a4d644d/772e8/mongo7.png 200w,\n/static/b92e7638ef07610e97be0f557a4d644d/e17e5/mongo7.png 400w,\n/static/b92e7638ef07610e97be0f557a4d644d/5a190/mongo7.png 800w,\n/static/b92e7638ef07610e97be0f557a4d644d/c1b63/mongo7.png 1200w,\n/static/b92e7638ef07610e97be0f557a4d644d/0d0e4/mongo7.png 1230w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Comme l'indique la vue, le <i>document</i> correspondant à la note a été ajouté à la collection <i>notes</i> de la base de données <i>myFirstDatabase</i>.</p>\n<picture><img src=\"/static/dfaeb55faf851c10a60ef501fbe8dcf1/5a190/mongo8.png\" srcset=\"/static/dfaeb55faf851c10a60ef501fbe8dcf1/772e8/mongo8.png 200w,\n/static/dfaeb55faf851c10a60ef501fbe8dcf1/e17e5/mongo8.png 400w,\n/static/dfaeb55faf851c10a60ef501fbe8dcf1/5a190/mongo8.png 800w,\n/static/dfaeb55faf851c10a60ef501fbe8dcf1/c1b63/mongo8.png 1200w,\n/static/dfaeb55faf851c10a60ef501fbe8dcf1/29007/mongo8.png 1600w,\n/static/dfaeb55faf851c10a60ef501fbe8dcf1/776d3/mongo8.png 1814w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Détruisons la base de données par défaut <i>myFirstDatabase</i> et changeons le nom de la base de données référencée dans notre chaîne de connexion en <i>noteApp</i> à la place, en modifiant l'URI :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">mongodb+srv://fullstack:<span class=\"token variable\">$thepasswordishere</span>@cluster0.o1opl.mongodb.net/noteApp?retryWrites<span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">w</span><span class=\"token operator\">=</span>majority</code></pre></div>\n<p>Exécutons à nouveau notre code :</p>\n<picture><img src=\"/static/9bdc595af70c904731fa90e1e4a89242/5a190/mongo9.png\" srcset=\"/static/9bdc595af70c904731fa90e1e4a89242/772e8/mongo9.png 200w,\n/static/9bdc595af70c904731fa90e1e4a89242/e17e5/mongo9.png 400w,\n/static/9bdc595af70c904731fa90e1e4a89242/5a190/mongo9.png 800w,\n/static/9bdc595af70c904731fa90e1e4a89242/c1b63/mongo9.png 1200w,\n/static/9bdc595af70c904731fa90e1e4a89242/bb543/mongo9.png 1418w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Les données sont maintenant stockées dans la bonne base de données. La vue offre également la fonctionnalité <i>créer une base de données</i>, qui peut être utilisée pour créer de nouvelles bases de données à partir du site Web. Créer la base de données comme ceci n'est pas nécessaire, puisque MongoDB Atlas crée automatiquement une nouvelle base de données lorsqu'une application tente de se connecter à une base de données qui n'existe pas encore.</p>\n<h3>Schema</h3>\n<p>Après avoir établi la connexion à la base de données, nous définissons le <a href=\"http://mongoosejs.com/docs/guide.html\">schéma</a> pour une note et le <a href=\"http://mongoosejs.com/docs/models.html\">modèle</a> correspondant :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">date</span><span class=\"token operator\">:</span> Date<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Tout d'abord, nous définissons le <a href=\"http://mongoosejs.com/docs/guide.html\">schéma</a> d'une note qui est stocké dans la variable <em>noteSchema</em>. Le schéma indique à Mongoose comment les objets note doivent être stockés dans la base de données.</p>\n<p>Dans la définition du modèle <em>Note</em>, le premier paramètre <i>\"Note\"</i> est le nom singulier du modèle. Le nom de la collection sera le pluriel en minuscules <i>notes</i>, car la <a href=\"http://mongoosejs.com/docs/models.html\">convention Mongoose</a> consiste à nommer automatiquement les collections au pluriel (par exemple <i>notes</i>) lorsque le schéma les désigne au singulier (par exemple <i>Note</i>).</p>\n<p>Les bases de données de documents comme Mongo sont <i>schemaless</i>, ce qui signifie que la base de données elle-même ne se soucie pas de la structure des données qui sont stockées dans la base. Il est possible de stocker des documents avec des champs complètement différents dans la même collection.</p>\n<p>L'idée derrière Mongoose est que les données stockées dans la base de données reçoivent un <i>schéma au niveau de l'application</i> qui définit la forme des documents stockés dans toute collection donnée.</p>\n<h3>Création et sauvegarde d'objets</h3>\n<p>Ensuite, l'application crée un nouvel objet note à l'aide du <i>Note</i> <a href=\"http://mongoosejs.com/docs/models.html\">modèle</a> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> <span class=\"token string\">'HTML is Easy'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">date</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Les modèles sont des fonctions dites <i>constructrices</i> qui créent de nouveaux objets JavaScript en fonction des paramètres fournis. Puisque les objets sont créés avec la fonction constructeur du modèle, ils ont toutes les propriétés du modèle, qui incluent des méthodes pour enregistrer l'objet dans la base de données.</p>\n<p>L'enregistrement de l'objet dans la base de données s'effectue à l'aide de la méthode <em>save</em>, qui peut être associée à un gestionnaire d'événements avec la méthode <em>then</em> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note saved!'</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Lorsque l'objet est enregistré dans la base de données, le gestionnaire d'événements fourni à <em>then</em> est appelé. Le gestionnaire d'événements ferme la connexion à la base de données avec la commande <code>mongoose.connection.close()</code>. Si la connexion n'est pas fermée, le programme ne terminera jamais son exécution.</p>\n<p>Le résultat de l'opération de sauvegarde se trouve dans le paramètre <em>result</em> du gestionnaire d'événements. Le résultat n'est pas très intéressant lorsque nous stockons un seul objet dans la base de données. Vous pouvez imprimer l'objet sur la console si vous souhaitez l'examiner de plus près lors de la mise en oeuvre de votre application ou pendant le débogage.</p>\n<p>Prenons également quelques notes supplémentaires en modifiant les données dans le code et en exécutant à nouveau le programme.</p>\n<p><strong>NB:</strong> Malheureusement, la documentation de Mongoose n'est pas très cohérente, certaines parties utilisant les callbacks dans leurs exemples et d'autres parties, d'autres styles, il n'est donc pas recommandé de copier-coller du code directement à partir de là. Il n'est pas recommandé de mélanger les promesses avec les callbacks de la vieille école dans le même code. </p>\n<h3>Récupération d'objets dans la base de données</h3>\n<p>Mettons en commentaire le code pour générer de nouvelles notes et remplaçons-le par ce qui suit :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  result<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Lorsque le code est exécuté, le programme imprime toutes les notes stockées dans la base de données :</p>\n<picture><img src=\"/static/a6fd392c94d0102772d9412d0ce8f3f4/5a190/70ea.png\" srcset=\"/static/a6fd392c94d0102772d9412d0ce8f3f4/772e8/70ea.png 200w,\n/static/a6fd392c94d0102772d9412d0ce8f3f4/e17e5/70ea.png 400w,\n/static/a6fd392c94d0102772d9412d0ce8f3f4/5a190/70ea.png 800w,\n/static/a6fd392c94d0102772d9412d0ce8f3f4/d5bfb/70ea.png 1072w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Les objets sont récupérés dans la base de données avec la méthode <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-find\">find</a> du modèle <em>Note</em>. Le paramètre de la méthode est un objet exprimant les conditions de recherche. Comme le paramètre est un objet vide<code>{}</code>, nous obtenons toutes les notes stockées dans la collection <em>notes</em>.</p>\n<p>Les conditions de recherche sont conformes à la requête de recherche Mongo <a href=\"https://www.mongodb.com/docs/manual/tutorial/query-documents/\">syntaxe</a>.</p>\n<p>Nous pourrions restreindre notre recherche pour n'inclure que les notes importantes comme ceci :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</div>\n<div class=\"tasks\">\n<h3>Exercice 3.12.</h3>\n<h4>3.12 : base de données en ligne de commande</h4>\n<p>Créez une base de données MongoDB basée sur le cloud pour l'application de répertoire téléphonique avec MongoDB Atlas. </p>\n<p>Créez un fichier <i>mongo.js</i> dans le répertoire du projet, qui peut être utilisé pour ajouter des entrées au répertoire et pour lister toutes les entrées existantes dans le répertoire.</p>\n<p><strong>NB:</strong> N'incluez pas le mot de passe dans le fichier que vous commettez et poussez sur GitHub ! </p>\n<p>L'application doit fonctionner comme suit. Vous utilisez le programme en passant trois arguments de ligne de commande (le premier est le mot de passe), par exemple :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js yourpassword Anna 040-1234556</code></pre></div>\n<p> En conséquence, l'application imprimera :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">added Anna number 040-1234556 to phonebook</code></pre></div>\n<p> La nouvelle entrée du répertoire sera enregistrée dans la base de données. Notez que si le nom contient des caractères d'espacement, il doit être placé entre guillemets :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js yourpassword <span class=\"token string\">\"Arto Vihavainen\"</span> 045-1232456</code></pre></div>\n<p> Si le mot de passe est le seul paramètre donné au programme, c'est-à-dire qu'il est invoqué comme ceci :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">node</span> mongo.js yourpassword</code></pre></div>\n<p> Alors le programme devrait afficher toutes les entrées du répertoire téléphonique :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">phonebook:\nAnna 040-1234556\nArto Vihavainen 045-1232456\nAda Lovelace 040-1231236</code></pre></div>\n<p>Vous pouvez obtenir les paramètres de la ligne de commande à partir de la variable <a href=\"https://nodejs.org/docs/latest-v8.x/api/process.html#process_process_argv\">process.argv</a>.</p>\n<p><strong>NB : ne pas fermer la connexion au mauvais endroit</strong>. Par exemple, le code suivant ne fonctionnera pas :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Person\n  <span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">persons</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Dans le code ci-dessus, la commande <i>mongoose.connection.close()</i> sera exécutée immédiatement après le lancement de l'opération <i>Person.find</i>. Cela signifie que la connexion à la base de données sera fermée immédiatement, et que l'exécution n'arrivera jamais au point où l'opération <i>Person.find</i> se termine et où la fonction <i>callback</i> est appelée.</p>\n<p>L'endroit correct pour fermer la connexion à la base de données est à la fin de la fonction callback :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">Person\n  <span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">persons</span><span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    mongoose<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>NB:</strong> Si vous définissez un modèle avec le nom <i>Person</i>, mongoose nommera automatiquement la collection associée comme <i>people</i>.</p>\n</div>\n<div class=\"content\">\n<h3>Backend connecté à une base de données</h3>\n<p>Maintenant, nous avons suffisamment de connaissances pour commencer à utiliser Mongo dans notre application.</p>\n<p>Commençons rapidement en copiant-collant les définitions de Mongoose dans le fichier <i>index.js</i> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// Assigns the second command line argument to 'password'</span>\n <span class=\"token keyword\">const</span> password <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// DO NOT SAVE YOUR PASSWORD TO GITHUB!!</span>\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span>\n  <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">mongodb+srv://fullstack:thepasswordishere@cluster0.o1opl.mongodb.net/noteApp?retryWrites=true&amp;w=majority</span><span class=\"token template-punctuation string\">`</span></span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">date</span><span class=\"token operator\">:</span> Date<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Modifions le gestionnaire pour récupérer toutes les notes sous la forme suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">notes</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Nous pouvons vérifier dans le navigateur que le backend fonctionne pour l'affichage de tous les documents :</p>\n<picture><img src=\"/static/321bffdcfa60d9fef6fefe5578eb4791/5a190/44ea.png\" srcset=\"/static/321bffdcfa60d9fef6fefe5578eb4791/772e8/44ea.png 200w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/e17e5/44ea.png 400w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/5a190/44ea.png 800w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/c1b63/44ea.png 1200w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/29007/44ea.png 1600w,\n/static/321bffdcfa60d9fef6fefe5578eb4791/5eb90/44ea.png 1612w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>L'application fonctionne presque parfaitement. Le frontend suppose que chaque objet a un id unique dans le champ <i>id</i>. Nous ne voulons pas non plus renvoyer le champ de versioning mongo <i>__v</i> au frontend.</p>\n<p>Une façon de formater les objets retournés par Mongoose est de <a href=\"https://stackoverflow.com/questions/7034848/mongodb-output-id-instead-of-id\">modifier</a> la méthode <em>toJSON</em> du schéma, qui est utilisée sur toutes les instances des modèles produits avec ce schéma. La modification de la méthode fonctionne comme suit :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">noteSchema<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toJSON'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">transform</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">document<span class=\"token punctuation\">,</span> returnedObject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    returnedObject<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> returnedObject<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>_id\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>__v\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Même si la propriété <i>_id</i> des objets Mongoose ressemble à une chaîne, il s'agit en fait d'un objet. La méthode <em>toJSON</em> que nous avons définie la transforme en chaîne de caractères par mesure de sécurité. Si nous ne faisions pas ce changement, cela nous causerait plus de tort à l'avenir, lorsque nous commencerons à écrire des tests.</p>\n<p>Répondons à la requête HTTP avec une liste d'objets formatés avec la méthode <em>toJSON</em> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">notes</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>notes<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Maintenant la variable <em>notes</em> est assignée à un tableau d'objets retournés par Mongo. Lorsque la réponse est envoyée au format JSON, la méthode <em>toJSON</em> de chaque objet du tableau est appelée automatiquement par la méthode <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify\">JSON.stringify</a>.</p>\n<h3>La configuration de la base de données dans son propre module</h3>\n<p>Avant de refactoriser le reste du backend pour utiliser la base de données, extrayons le code spécifique à Mongoose dans son propre module.</p>\n<p>Créons un nouveau répertoire pour le module appelé <i>models</i>, et ajoutons un fichier appelé <i>note.js</i> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mongoose'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MONGODB_URI</span></span>\n<span class=\"gatsby-highlight-code-line\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connecting to'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span></span>\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected to MongoDB'</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error connecting to MongoDB:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token keyword\">const</span> noteSchema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mongoose<span class=\"token punctuation\">.</span>Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">date</span><span class=\"token operator\">:</span> Date<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> Boolean<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nnoteSchema<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'toJSON'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">transform</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">document<span class=\"token punctuation\">,</span> returnedObject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    returnedObject<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> returnedObject<span class=\"token punctuation\">.</span>_id<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>_id\n    <span class=\"token keyword\">delete</span> returnedObject<span class=\"token punctuation\">.</span>__v\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"gatsby-highlight-code-line\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Note'</span><span class=\"token punctuation\">,</span> noteSchema<span class=\"token punctuation\">)</span></span></code></pre></div>\n<p>La définition des [modules] de Node (<a href=\"https://nodejs.org/docs/latest-v8.x/api/modules.html\">https://nodejs.org/docs/latest-v8.x/api/modules.html</a>) diffère légèrement de la manière de définir les <a href=\"/fr/part2/rendering_a_collection_modules#refactoring-modules\">modules ES6</a> dans la partie 2.</p>\n<p>L'interface publique du module est définie en attribuant une valeur à la variable <em>module.exports</em>. Nous allons définir la valeur comme étant le modèle <i>Note</i>. Les autres choses définies à l'intérieur du module, comme les variables <em>mongoose</em> et <em>url</em> ne seront pas accessibles ou visibles pour les utilisateurs du module.</p>\n<p>L'importation du module se fait en ajoutant la ligne suivante à <i>index.js</i> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./models/note'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>De cette façon, la variable <em>Note</em> sera affectée au même objet que celui défini par le module.</p>\n<p>La façon dont la connexion est établie a légèrement changé :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">MONGODB_URI</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connecting to'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">)</span>\n\nmongoose<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'connected to MongoDB'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error connecting to MongoDB:'</span><span class=\"token punctuation\">,</span> error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Ce n'est pas une bonne idée de coder en dur l'adresse de la base de données dans le code, donc à la place l'adresse de la base de données est transmise à l'application via la variable d'environnement <em>MONGODB_URI</em>.</p>\n<p>La méthode d'établissement de la connexion est maintenant dotée de fonctions permettant de traiter une tentative de connexion réussie ou non. Les deux fonctions se contentent de consigner un message dans la console concernant l'état de réussite :</p>\n<picture><img src=\"/static/b7b715296b130693831cc719ea8d2f99/5a190/45e.png\" srcset=\"/static/b7b715296b130693831cc719ea8d2f99/772e8/45e.png 200w,\n/static/b7b715296b130693831cc719ea8d2f99/e17e5/45e.png 400w,\n/static/b7b715296b130693831cc719ea8d2f99/5a190/45e.png 800w,\n/static/b7b715296b130693831cc719ea8d2f99/c1b63/45e.png 1200w,\n/static/b7b715296b130693831cc719ea8d2f99/35890/45e.png 1582w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Il existe de nombreuses façons de définir la valeur d'une variable d'environnement. L'une d'elles consiste à la définir au démarrage de l'application :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">MONGODB_URI</span><span class=\"token operator\">=</span>address_here <span class=\"token function\">npm</span> run dev</code></pre></div>\n<p>Une méthode plus sophistiquée consiste à utiliser la bibliothèque <a href=\"https://github.com/motdotla/dotenv#readme\">dotenv</a>. Vous pouvez installer la bibliothèque avec la commande :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> dotenv</code></pre></div>\n<p>Pour utiliser la bibliothèque, nous créons un fichier <i>.env</i> à la racine du projet. Les variables d'environnement sont définies à l'intérieur du fichier, et il peut ressembler à ceci :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">MONGODB_URI</span><span class=\"token operator\">=</span>mongodb+srv://fullstack:thepasswordishere@cluster0.o1opl.mongodb.net/noteApp?retryWrites<span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">w</span><span class=\"token operator\">=</span>majority\n<span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3001</span></code></pre></div>\n<p> Nous avons également ajouté le port en dur du serveur dans la variable d'environnement <em>PORT</em>.</p>\n<p><strong>Le fichier <i>.env</i> doit être gitignoré tout de suite, car nous ne voulons pas publier d'informations confidentielles publiquement en ligne !</strong></p>\n<picture><img src=\"/static/e12482f21c1bd50aaa9fa2e9a85169f1/5a190/45ae.png\" srcset=\"/static/e12482f21c1bd50aaa9fa2e9a85169f1/772e8/45ae.png 200w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/e17e5/45ae.png 400w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/5a190/45ae.png 800w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/c1b63/45ae.png 1200w,\n/static/e12482f21c1bd50aaa9fa2e9a85169f1/f2f8c/45ae.png 1490w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Les variables d'environnement définies dans le fichier <i>.env</i> peuvent être prises en compte avec l'expression <em>require('dotenv').config()</em> et vous pouvez les référencer dans votre code comme vous référeriez des variables d'environnement normales, avec la syntaxe familière <em>process.env.MONGODB_URI</em>.</p>\n<p>Modifions le fichier <i>index.js</i> de la manière suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dotenv'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">config</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> Note <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./models/note'</span><span class=\"token punctuation\">)</span></span>\n<span class=\"token comment\">// ..</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PORT</span></span>app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Server running on port </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token constant\">PORT</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Il est important que <i>dotenv</i> soit importé avant que le modèle <i>note</i> soit importé. Cela garantit que les variables d'environnement du fichier <i>.env</i> sont disponibles globalement avant que le code des autres modules ne soit importé.</p>\n<p>Une fois que le fichier .env a été gitignoré, Heroku ne récupère pas l'url de la base de données à partir du référentiel, vous devez donc le définir vous-même. Cela peut être fait via le tableau de bord Heroku comme suit :</p>\n<picture><img src=\"/static/c153a824158cc5268d60867e176771d3/5a190/herokuConfig.png\" srcset=\"/static/c153a824158cc5268d60867e176771d3/772e8/herokuConfig.png 200w,\n/static/c153a824158cc5268d60867e176771d3/e17e5/herokuConfig.png 400w,\n/static/c153a824158cc5268d60867e176771d3/5a190/herokuConfig.png 800w,\n/static/c153a824158cc5268d60867e176771d3/eb390/herokuConfig.png 935w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>ou depuis la ligne de commande avec la commande :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">heroku config:set MONGODB_URI='mongodb+srv://fullstack:thepasswordishere@cluster0.o1opl.mongodb.net/noteApp?retryWrites=true&amp;w=majority'</code></pre></div>\n<h3>Utilisation de la base de données dans les gestionnaires de route</h3>\n<p>Ensuite, changeons le reste de la fonctionnalité du backend pour utiliser la base de données.</p>\n<p>La création d'une nouvelle note se fait comme suit :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">.</span>content <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'content missing'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Note</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">date</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  note<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">savedNote</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Les objets note sont créés avec la fonction constructrice <em>Note</em>. La réponse est envoyée dans la fonction de rappel de l'opération <em>save</em>. Cela garantit que la réponse n'est envoyée que si l'opération a réussi. Nous aborderons la gestion des erreurs un peu plus tard.</p>\n<p>Le paramètre <em>savedNote</em> de la fonction de rappel est la note sauvegardée et nouvellement créée. Les données renvoyées dans la réponse sont la version formatée créée avec la méthode <em>toJSON</em> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>savedNote<span class=\"token punctuation\">)</span></code></pre></div>\n<p>En utilisant la méthode <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findById\">findById</a> de Mongoose, la récupération d'une note individuelle se transforme en ce qui suit :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Vérification de l'intégration du front-end et du back-end</h3>\n<p>Lorsque le backend est étendu, c'est une bonne idée de tester d'abord le backend avec <strong>le navigateur, Postman ou le client REST de VS Code</strong>. Ensuite, essayons de créer une nouvelle note après avoir pris en compte la base de données :</p>\n<picture><img src=\"/static/fedf336aae9e573fbfa4fe03f6f407e1/5a190/46e.png\" srcset=\"/static/fedf336aae9e573fbfa4fe03f6f407e1/772e8/46e.png 200w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/e17e5/46e.png 400w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/5a190/46e.png 800w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/c1b63/46e.png 1200w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/29007/46e.png 1600w,\n/static/fedf336aae9e573fbfa4fe03f6f407e1/3e992/46e.png 1902w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<p>Ce n'est qu'une fois que l'on a vérifié que tout fonctionne dans le backend, qu'il est bon de tester que le frontend fonctionne avec le backend. Il est très inefficace de tester les choses exclusivement par le biais du frontend.</p>\n<p>C'est probablement une bonne idée d'intégrer le frontend et le backend une fonctionnalité à la fois. Tout d'abord, nous pourrions implémenter la récupération de toutes les notes de la base de données et la tester via le point de terminaison du backend dans le navigateur. Ensuite, nous pourrions vérifier que le frontend fonctionne avec le nouveau backend. Une fois que tout semble fonctionner, nous pourrions passer à la fonctionnalité suivante.</p>\n<p>Une fois que nous introduisons une base de données dans le mélange, il est utile d'inspecter l'état persistant dans la base de données, par exemple à partir du panneau de contrôle dans MongoDB Atlas. Très souvent, de petits programmes d'aide Node comme le programme <i>mongo.js</i> que nous avons écrit précédemment peuvent être très utiles pendant le développement.</p>\n<p>Vous pouvez trouver le code de notre application actuelle dans son intégralité dans la branche <i>part3-4</i> de <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-4\">ce dépôt GitHub</a>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Exercices 3.13.-3.14.</h3>\n<p>Les exercices suivants sont assez simples, mais si votre frontend cesse de fonctionner avec le backend, alors trouver et corriger les bugs peut être assez intéressant. </p>\n<h4>3.13 : Base de données du répertoire téléphonique, étape 1</h4>\n<p>Changez la récupération de toutes les entrées du répertoire téléphonique pour que les données soient <i>retirées de la base de données</i>.</p>\n<p>Vérifiez que le frontend fonctionne après que les changements ont été faits.</p>\n<p>Dans les exercices suivants, écrivez tout le code spécifique à Mongoose dans son propre module, comme nous l'avons fait dans le chapitre <a href=\"/fr/part3/saving_data_to_mongo_db#database-configuration-into-its-own-module\">Configuration de la base de données dans son propre module</a>.</p>\n<h4>3.14 : Base de données du répertoire téléphonique, étape 2</h4>\n<p>Changez le backend pour que les nouveaux numéros soient <i>sauvegardés dans la base de données</i>. Vérifiez que votre frontend fonctionne toujours après les changements.</p>\n<p>À ce stade, vous pouvez choisir de simplement autoriser les utilisateurs à créer toutes les entrées du répertoire téléphonique. À ce stade, le répertoire téléphonique peut avoir plusieurs entrées pour une personne ayant le même nom. </p>\n</div>\n<div class=\"content\">\n<h3>Traitement des erreurs</h3>\n<p>Si nous essayons de visiter l'URL d'une note avec un id qui n'existe pas réellement, par exemple <a href=\"http://localhost:3001/api/notes/5c41c90e84d891c15dfa3431\">http://localhost:3001/api/notes/5c41c90e84d891c15dfa3431</a> où <i>5c41c90e84d891c15dfa3431</i> n'est pas un id stocké dans la base de données, alors la réponse sera <em>null</em>.</p>\n<p>Changeons ce comportement pour que si la note avec l'id donné n'existe pas, le serveur répondra à la requête avec le code de statut HTTP 404 not found. En outre, implémentons un simple bloc <em>catch</em> pour gérer les cas où la promesse retournée par la méthode <em>findById</em> est <i>rejetée</i> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token punctuation\">}</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Si aucun objet correspondant n'est trouvé dans la base de données, la valeur de <em>note</em> sera <em>null</em> et le bloc <em>else</em> sera exécuté. Il en résulte une réponse avec le code d'état <i>404 not found</i>. Si la promesse renvoyée par la méthode <em>findById</em> est rejetée, la réponse aura le code d'état <i>500 internal server error</i>. La console affiche des informations plus détaillées sur l'erreur.</p>\n<p>En plus de la note inexistante, il y a une autre situation d'erreur qui doit être traitée. Dans cette situation, nous essayons de récupérer une note avec un mauvais type d'<em>id</em>, c'est-à-dire un <em>id</em> qui ne correspond pas au format d'identifiant mongo.</p>\n<p>Si nous effectuons la requête suivante, nous obtiendrons le message d'erreur indiqué ci-dessous :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Method: GET\nPath:   /api/notes/someInvalidId\nBody:   {}\n---\n{ CastError: Cast to ObjectId failed for value \"someInvalidId\" at path \"_id\"\n    at CastError (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/error/cast.js:27:11)\n    at ObjectId.cast (/Users/mluukkai/opetus/_fullstack/osa3-muisiinpanot/node_modules/mongoose/lib/schema/objectid.js:158:13)\n    ...</code></pre></div>\n<p>Étant donné un id malformé comme argument, la méthode <em>findById</em> lancera une erreur provoquant le rejet de la promesse retournée. Cela provoquera l'appel de la fonction callback définie dans le bloc <em>catch</em>. </p>\n<p>Faisons quelques petits ajustements à la réponse dans le bloc <em>catch</em> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Si le format de l'identifiant est incorrect, nous nous retrouverons dans le gestionnaire d'erreur défini dans le bloc <em>catch</em>. Le code d'état approprié pour cette situation est <a href=\"https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1\">400 Bad Request</a>, car la situation correspond parfaitement à la description :</p>\n<blockquote>\n<p><i>La demande n'a pas pu être comprise par le serveur en raison d'une syntaxe malformée. Le client NE DEVRAIT PAS répéter la demande sans modifications.</i></p>\n</blockquote>\n<p>Nous avons également ajouté quelques données à la réponse pour faire la lumière sur la cause de l'erreur.</p>\n<p>Lorsque vous traitez avec des Promesses, c'est presque toujours une bonne idée d'ajouter la gestion des erreurs et des exceptions, car sinon vous vous retrouverez à traiter des bugs étranges.</p>\n<p>Ce n'est jamais une mauvaise idée d'imprimer l'objet qui a causé l'exception sur la console dans le gestionnaire d'erreur :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span></span>  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>La raison pour laquelle le gestionnaire d'erreurs est appelé peut être complètement différente de ce que vous aviez prévu. Si vous consignez l'erreur dans la console, vous vous épargnerez de longues et frustrantes sessions de débogage. En outre, la plupart des services modernes sur lesquels vous déployez votre application prennent en charge une certaine forme de système de journalisation que vous pouvez utiliser pour vérifier ces journaux. Comme nous l'avons mentionné, Heroku en est un.</p>\n<p>Chaque fois que vous travaillez sur un projet avec un backend, <i>il est essentiel de garder un oeil sur la sortie console du backend</i>. Si vous travaillez sur un petit écran, il suffit de voir une toute petite tranche de la sortie en arrière-plan. Tout message d'erreur attirera votre attention même si la console est loin en arrière-plan :</p>\n<picture><img src=\"/static/b5656dca7416a1a37670dc5a51bfbbc7/5a190/15b.png\" srcset=\"/static/b5656dca7416a1a37670dc5a51bfbbc7/772e8/15b.png 200w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/e17e5/15b.png 400w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/5a190/15b.png 800w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/c1b63/15b.png 1200w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/29007/15b.png 1600w,\n/static/b5656dca7416a1a37670dc5a51bfbbc7/966ce/15b.png 2050w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n<h3>Déplacer la gestion des erreurs dans le middleware</h3>\n<p>Nous avons écrit le code pour le gestionnaire d'erreurs parmi le reste de notre code. Cela peut être une solution raisonnable à certains moments, mais il y a des cas où il est préférable d'implémenter toute la gestion des erreurs à un seul endroit. Cela peut s'avérer particulièrement utile si nous souhaitons par la suite transmettre les données relatives aux erreurs à un système externe de suivi des erreurs comme <a href=\"https://sentry.io/welcome/\">Sentry</a>.</p>\n<p>Modifions le gestionnaire de la route <i>/api/notes/:id</i>, afin qu'il transmette l'erreur avec la fonction <em>next</em>. La fonction next est passée au handler comme troisième paramètre :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"gatsby-highlight-code-line\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span>  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>note<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>L'erreur qui est transmise en amont est donnée à la fonction <em>next</em> en tant que paramètre. Si <em>next</em> était appelée sans paramètre, alors l'exécution passerait simplement à la route ou au middleware suivant. Si la fonction <em>next</em> est appelée avec un paramètre, alors l'exécution se poursuivra jusqu'au <i>milieu de traitement des erreurs</i>.</p>\n<p>Les <a href=\"https://expressjs.com/en/guide/error-handling.html\">error handlers</a> d'express sont des middlewares qui sont définis avec une fonction qui accepte <i>quatre paramètres</i>. Notre gestionnaire d'erreur ressemble à ceci :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'CastError'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">400</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'malformatted id'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> \n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// this has to be the last loaded middleware.</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Le gestionnaire d'erreur vérifie si l'erreur est une exception <i>CastError</i>, auquel cas nous savons que l'erreur a été causée par un id d'objet invalide pour Mongo. Dans cette situation, le gestionnaire d'erreur enverra une réponse au navigateur avec l'objet de réponse passé en paramètre. Dans toutes les autres situations d'erreur, le middleware transmet l'erreur au gestionnaire d'erreur Express par défaut. </p>\n<p>Notez que le middleware de gestion des erreurs doit être le dernier middleware chargé !</p>\n<h3>L'ordre de chargement des middlewares</h3>\n<p>L'ordre d'exécution des middlewares est le même que l'ordre dans lequel ils sont chargés dans Express avec la fonction <em>app.use</em>. Pour cette raison, il est important d'être prudent lors de la définition des middlewares.</p>\n<p>L'ordre correct est le suivant :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'build'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>requestLogger<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// handler of requests with unknown endpoint</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>unknownEndpoint<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">errorHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// handler of requests with result to errors</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>errorHandler<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Le middleware json-parser devrait être parmi les tout premiers middleware chargés dans Express. Si l'ordre était le suivant :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>requestLogger<span class=\"token punctuation\">)</span> <span class=\"token comment\">// request.body is undefined!</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// request.body is undefined!</span>\n    <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Les données JSON envoyées avec les requêtes HTTP ne seraient alors pas disponibles pour le middleware du logger ou le gestionnaire de route POST, puisque le <em>request.body</em> serait <em>undefined</em> à ce moment-là.</p>\n<p>Il est également important que le middleware de gestion des routes non prises en charge soit le dernier middleware chargé dans Express, juste avant le gestionnaire d'erreurs.</p>\n<p>Par exemple, l'ordre de chargement suivant causerait un problème :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">unknownEndpoint</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'unknown endpoint'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// handler of requests with unknown endpoint</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>unknownEndpoint<span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Maintenant, le traitement des points de terminaison inconnus est ordonné <i>avant le gestionnaire de requête HTTP</i>. Puisque le gestionnaire de points de terminaison inconnus répond à toutes les demandes avec <i>404 unknown endpoint</i>, aucune route ou middleware ne sera appelée après que la réponse ait été envoyée par le middleware de points de terminaison inconnus. La seule exception à cela est le gestionnaire d'erreur qui doit venir à la toute fin, après le gestionnaire de points de terminaison inconnus.</p>\n<h3>Autres opérations</h3>\n<p>Ajoutons quelques fonctionnalités manquantes à notre application, notamment la suppression et la mise à jour d'une note individuelle.</p>\n<p>La façon la plus simple de supprimer une note de la base de données est d'utiliser la méthode <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndDelete\">findByIdAndDelete</a> :</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndDelete</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">204</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Dans les deux cas de \"réussite\" de la suppression d'une ressource, le backend répond avec le code d'état <i>204 no content</i>. Les deux cas différents sont la suppression d'une note qui existe, et la suppression d'une note qui n'existe pas dans la base de données. Le paramètre de callback <em>result</em> pourrait être utilisé pour vérifier si une ressource a effectivement été supprimée, et nous pourrions utiliser cette information pour renvoyer des codes d'état différents pour les deux cas si nous le jugions nécessaire. Toute exception qui se produit est transmise au gestionnaire d'erreurs.</p>\n<p>Le changement de l'importance d'une note peut être facilement réalisé avec la méthode <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndUpdate\">findByIdAndUpdate</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/api/notes/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>body\n\n  <span class=\"token keyword\">const</span> note <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">content</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">important</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">.</span>important<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  Note<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdAndUpdate</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> note<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token keyword\">new</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">updatedNote</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>updatedNote<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Dans le code ci-dessus, nous permettons également de modifier le contenu de la note. Cependant, nous ne prendrons pas en charge la modification de la date de création pour des raisons évidentes.</p>\n<p>Remarquez que la méthode <em>findByIdAndUpdate</em> reçoit un objet JavaScript ordinaire comme paramètre, et non un nouvel objet note créé avec la fonction constructeur <em>Note</em>.</p>\n<p>Il existe un détail important concernant l'utilisation de la méthode <em>findByIdAndUpdate</em>. Par défaut, le paramètre <em>updatedNote</em> du gestionnaire d'événements reçoit le document original <a href=\"https://mongoosejs.com/docs/api/model.html#model_Model-findByIdAndUpdate\">sans les modifications</a>. Nous avons ajouté le paramètre optionnel <code>{ new : true }</code>, qui fera en sorte que notre gestionnaire d'événements soit appelé avec le nouveau document modifié au lieu de l'original.</p>\n<p>Après avoir testé le backend directement avec Postman et le client REST de VS Code, nous pouvons vérifier qu'il semble fonctionner. Le frontend semble également fonctionner avec le backend en utilisant la base de données. </p>\n<p>Vous pouvez trouver le code de notre application actuelle dans son intégralité dans la branche <i>part3-5</i> de <a href=\"https://github.com/fullstack-hy2020/part3-notes-backend/tree/part3-5\">ce dépôt GitHub</a>.</p>\n</div>\n<div class=\"tasks\">\n<h3>Exercices 3.15.-3.18.</h3>\n<h4>3.15 : Base de données du répertoire téléphonique, étape3</h4>\n<p>Modifiez le backend pour que la suppression des entrées du répertoire téléphonique soit répercutée dans la base de données.</p>\n<p>Vérifiez que le frontend fonctionne toujours après avoir fait les changements.</p>\n<h4>3.16 : Base de données du répertoire téléphonique, étape 4</h4>\n<p>Déplacer la gestion des erreurs de l'application vers un nouveau middleware de gestion des erreurs. </p>\n<h4>3.17* : Base de données du répertoire téléphonique, étape 5</h4>\n<p>Si l'utilisateur essaie de créer une nouvelle entrée dans le répertoire pour une personne dont le nom est déjà dans le répertoire, le frontend va essayer de mettre à jour le numéro de téléphone de l'entrée existante en faisant une requête HTTP PUT à l'URL unique de l'entrée.</p>\n<p>Modifiez le backend pour supporter cette requête.</p>\n<p>Vérifiez que le frontend fonctionne après avoir fait vos changements.</p>\n<h4>3.18* : Base de données du répertoire téléphonique étape6</h4>\n<p>Mettez également à jour la gestion des routes <i>api/persons/:id</i> et <i>info</i> pour utiliser la base de données, et vérifiez qu'elles fonctionnent directement avec le navigateur, Postman, ou le client REST de VS Code.</p>\n<p>L'inspection d'une entrée de répertoire individuelle depuis le navigateur devrait ressembler à ceci :</p>\n<picture><img src=\"/static/853a1d57372a2b5c8fc1249b682d59a7/5a190/49.png\" srcset=\"/static/853a1d57372a2b5c8fc1249b682d59a7/772e8/49.png 200w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/e17e5/49.png 400w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/5a190/49.png 800w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/c1b63/49.png 1200w,\n/static/853a1d57372a2b5c8fc1249b682d59a7/c655d/49.png 1586w\" sizes=\"(max-width: 800px) 100vw, 800px\"></picture>\n </div>","frontmatter":{"mainImage":{"publicURL":"/static/8ac7bc0fb2b7018a7853b00c454b2103/part-3.svg"},"part":3,"letter":"c","lang":"fr"}}},"pageContext":{"part":3,"letter":"c","lang":"fr"}},"staticQueryHashes":["3128451518"]}